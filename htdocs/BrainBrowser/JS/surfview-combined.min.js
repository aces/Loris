function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(g,o,n,k,r,d,l){var n=n.colors;var q=new Array();var p=((o-g)+(o-g)/n.length)/n.length;for(var h=0;h<a.values.length;h++){if(a.values[h]<=g){if(a.values[h]<g&&!r){var s=-1}else{var s=0}}else{if(a.values[h]>o){if(!r){var s=-1}else{var s=n.length-1}}else{var s=parseInt((a.values[h]-g)/p)}}if(k&&s!=-1){q.push.apply(q,n[n.length-1-s])}else{if(s==-1){if(d.length==4){q.push.apply(q,d)}else{q.push.apply(q,[d[h*4],d[h*4+1],d[h*4+2],d[h*4+3]])}}else{q.push.apply(q,n[s])}}}if(l.num_hemisphere!=2){var m=[];var c=l.indexArray.length;for(var f=0;f<c;f++){m[f*4]=q[l.indexArray[f]*4];m[f*4+1]=q[l.indexArray[f]*4+1];m[f*4+2]=q[l.indexArray[f]*4+2];m[f*4+3]=q[l.indexArray[f]*4+3]}q.nonIndexedColorArray=m}return q};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[b*d+(d-c)]}}return f}function rotateUint16Array90Right(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[(a-b)*d+c]}}return f}function interpolateDataArray(h,c,b,a){console.log(h.values.length);var f=h.values.length;var g=new Array(f);console.log("Percentage: "+b);for(var d=0;d<f;d++){if(a){g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(g.length);return g}function ColorManager(){function c(m,d,q,j,o,l,n,h,g){var m=m.colors;var p=((o-j)+(o-j)/m.length)/m.length;for(var k=0;k<q.length;k++){if(q[k]<=j){var r=0}else{if(q[k]>o){var r=m.length-1}else{var r=parseInt((q[k]-j)/p)}}if(l){var f=255}else{var f=1}d[k*4+0]=f*m[r][0]*h+n*f;d[k*4+1]=f*m[r][1]*h+n*f;d[k*4+2]=f*m[r][2]*h+n*f;if(g){d[k*4+3]=f*g}else{d[k*4+3]=f}}return d}this.createColorMap=c;function a(l){var d=l[0];for(var h=0;h<l[0].length/4;h++){for(var g=1;g<l.length;g++){var f=d[h*4+3];var k=l[g][h*4+3];d[h*4]=d[h*4]*f+l[g][h*4]*k;d[h*4+1]=d[h*4+1]*f+l[g][h*4+1]*k;d[h*4+2]=d[h*4+2]*f+l[g][h*4+2]*k;d[h*4+3]=f+k}}return d}this.blendColors=a;function b(f,m,k,h){var d=m.length;var l=new Array(d);var j=0;for(var g=0;g<d;g++){l[g]=c(f,new Array(m[g].values.length),m[g].values,m[g].rangeMin,m[g].rangeMax,false,0,1,m[g].alpha)}return a(l)}this.blendColorMap=b}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");jQuery(l).attr("width",256);jQuery(l).attr("height",j);var m=new Array(256);for(var o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);var h=l.getContext("2d");for(var n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4])+","+parseInt(g[n*4+1])+","+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}console.log("rgb("+parseInt(g[100*4+0])+","+parseInt(g[100*4+1])+","+parseInt(g[100*4+2]));console.log(h.fillStyle);return l}c.createSpectrumCanvas=function(g){if(g==null){g=c.colors}var h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){if(h==null){h=c.colors}var j=b(h,20,40,m);var k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(n){n=n.replace(/\s+$/,"");n=n.replace(/^\s+/,"");var l=n.split(/\n/);var g=new Array();for(var j=0;j<l.length;j++){var m=l[j].replace(/\s+$/,"").split(/\s+/);for(var h=0;h<m.length;h++){m[h]=parseFloat(m[h])}if(m.length<4){m.push(1)}g.push(m)}c.colors=g;return g}if(f!=undefined){d(f)}}function WaveformObj(G){var p=this;G=G.split("\n");p.shapes=[];var A;var o=[];var q=[];var E=[];A={name:G.name|"undefined",indexArray:[],texIndexArray:[],normalIndexArray:[]};p.shapes.push(A);for(var z=0;z<G.length;z++){var j=G[z].split(/\s+/);if(!(j[0].match("#"))||j==""){if(j[0]=="o"|j[0]=="g"){console.log(j[1]);A={name:j[1],indexArray:[],texIndexArray:[],normalIndexArray:[]};p.shapes.push(A)}else{if(j[0]=="v"){o.push(parseFloat(j[1]));o.push(parseFloat(j[2]));o.push(parseFloat(j[3]))}else{if(j[0]=="vt"){for(var r=1;r<j.length;r++){q.push(parseFloat(j[r]))}}else{if(j[0]=="vn"){E.push(parseFloat(j[1]));E.push(parseFloat(j[2]));E.push(parseFloat(j[3]))}else{if(j[0]=="f"){for(var v=1;v<4;v++){var C=j[v].split("/");A.indexArray.push(parseInt(C[0])-1);A.texIndexArray.push(parseInt(C[1])-1);if(C[2]){A.normalIndexArray.push(parseInt(C[2])-1)}}if(j.length>=4){for(v;v<j.length;v++){var C=j[v].split("/");var B=A.indexArray.length;A.indexArray.push(A.indexArray[B-1]);A.indexArray.push(A.indexArray[B-3]);A.indexArray.push(C[0]-1)}}}}}}}}}var f=Array(o.length/3);var u=p.shapes.length;for(var t=0;t<u;t++){var b=p.shapes[t];b.vertexArray=[];b.normalArray=[];b.texCoordArray=[];var w=b.indexArray.length;for(var s=0;s<w;s++){b.vertexArray.push(o[(b.indexArray[s])*3]);b.vertexArray.push(o[(b.indexArray[s])*3+1]);b.vertexArray.push(o[(b.indexArray[s])*3+2]);if(b.normalIndexArray.length>0){b.normalArray.push(E[(b.normalIndexArray[s])*3]);b.normalArray.push(E[(b.normalIndexArray[s])*3+1]);b.normalArray.push(E[(b.normalIndexArray[s])*3+2])}}for(var h=0;h<w;h+=3){var g=[];g[0]=(b.indexArray[h]);g[1]=(b.indexArray[h+1]);g[2]=(b.indexArray[h+2]);var x=[];x[0]=[o[g[0]*3],o[g[0]*3+1],o[g[0]*3+2]];x[1]=[o[g[1]*3],o[g[1]*3+1],o[g[1]*3+2]];x[2]=[o[g[2]*3],o[g[2]*3+1],o[g[2]*3+2]];var c=[x[1][0]-x[0][0],x[1][1]-x[0][1],x[1][2]-x[0][2]];var a=[x[2][0]-x[0][0],x[2][1]-x[0][1],x[2][2]-x[0][2]];var F=vec3.normalize(vec3.cross(c,a,[]));for(var D=0;D<3;D++){if(f[g[D]]!=undefined){vec3.add(f[g[D]],F);f[g[D]]=F}else{f[g[D]]=F}}}for(var h=0;h<w;h++){var F=vec3.normalize(f[b.indexArray[h]],[]);b.normalArray.push(F[0]);b.normalArray.push(F[1]);b.normalArray.push(F[2]);if(h==0){console.log(F);console.log(b.normalArray[b.normalArray.length-1]);console.log(b.normalArray[b.normalArray.length-2]);console.log(b.normalArray[b.normalArray.length-3])}}console.log("VERTICES: "+b.vertexArray.length);console.log("NORMALS: "+b.normalArray.length);b.positionArray=b.vertexArray;b.colorArray=[0.8,0.8,0.8,1];b.nonindexed=true}p.objectClass="P";p.vertexArray=o;p.texCoordArray=q}function MNIObject(d){var k;var h=this;function b(n){h.num_hemispheres=1;var m=n.replace(/\s+$/,"");var o=m.replace(/^\s+/,"");k=o.split(/\s+/).reverse();h.objectClass=k.pop();if(h.objectClass=="P"){f();h.numberVertices=parseInt(k.pop());g();l();h.nitems=parseInt(k.pop())}else{if(h.objectClass=="L"){f();h.numberVertices=parseInt(k.pop());g();h.nitems=parseInt(k.pop())}else{throw new Error("That object class is not supported currently")}}j();c();a();if(h.objectClass=="P"){if(h.positionArray.length==81924*3){h.brainSurface=true;h.split_hemispheres()}}}function f(){if(h.objectClass=="P"){h.surfaceProperties={ambient:parseFloat(k.pop()),diffuse:parseFloat(k.pop()),specular_reflectance:parseFloat(k.pop()),specular_scattering:parseFloat(k.pop()),transparency:parseFloat(k.pop())}}else{if(h.objectClass=="L"){h.surfaceProperties={width:k.pop()}}}}function g(){h.positionArray=new Array();for(var m=0;m<h.numberVertices;m++){for(var n=0;n<3;n++){h.positionArray.push(parseFloat(k.pop()))}}}function l(){h.normalArray=new Array();for(var o=0;o<h.numberVertices;o++){for(var m=0;m<3;m++){h.normalArray.push(parseFloat(k.pop()))}}}function j(){h.colorFlag=parseInt(k.pop());h.colorArray=new Array();if(h.colorFlag===0){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}else{if(h.colorFlag===1){for(var n=0;n<h.numberPolygons;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{if(h.colorFlag===2){for(var n=0;n<h.numberVertices;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){h.endIndicesArray=new Array();for(var m=0;m<h.nitems;m++){h.endIndicesArray.push(parseInt(k.pop()))}}function a(){h.indexArray=new Array();var n=k.length;for(var m=0;m<n;m++){h.indexArray.push(parseInt(k.pop()))}}h.split_hemispheres=function(){h.left={};h.right={};var q=h.positionArray.length;h.left.positionArray=h.positionArray.slice(0,q/2);h.right.positionArray=h.positionArray.slice(q/2,q);var p=h.indexArray.length;h.left.indexArray=h.indexArray.slice(0,p/2);h.right.indexArray=h.indexArray.slice(p/2,p);for(var m=0;m<h.right.indexArray.length;m++){h.right.indexArray[m]=h.right.indexArray[m]-2-p/3/2/2}var n=h.normalArray.length;h.left.normalArray=h.normalArray.slice(0,n/2);h.right.normalArray=h.normalArray.slice(n/2,n);h.left.colorFlag=h.colorFlag;h.right.colorFlag=h.colorFlag;if(h.colorFlag==0||h.colorFlag==1){h.left.colorArray=h.colorArray;h.right.colorArray=h.colorArray}else{var o=h.colorArray.length;h.left.colorArray=h.colorArray.slice(0,o/2);h.right.colorArray=h.colorArray.slice(o/2+1,-1)}h.left.numberVertices=h.numberVertices/2;h.right.numberVertices=h.numberVertices/2;h.left.numberPolygons=h.numberPolygons/2;h.right.numberPolygons=h.numberPolygons/2;h.num_hemispheres=2};h.getVertexInfo=function(n){var m=[h.positionArray[n*3],h.positionArray[n*3+1],h.positionArray[n*3+2]];return{vertex:n,position_vector:m}};h.get_vertex=function(w,t,m){if(h.num_hemispheres>1){var s=h[m];var p=0;if(m=="right"){p=2+s.indexArray.length/3/2}}else{var s=h;var p=0}var r=new Array();var z=w*3;for(var q=0;q<3;q++){r.push(s.indexArray[z+q])}var x=new Array();for(var q=0;q<3;q++){var v=r[q]*3;x[q]=new Array();for(var o=0;o<3;o++){x[q][o]=s.positionArray[v+o]}}var y=new Array();for(var q=0;q<3;q++){y.push(o3djs.math.distance(t,x[q]))}var n=0;if(y[1]<y[0]){n=1}if(y[2]<y[n]){n=2}var u=r[n]+p;var A=x[n];return{vertex:u,position_vector:A}};if(d){b(d)}}function bbObject(a){var b=a;b.createBrain=function(d,c){b.model_data=d;if(d.num_hemispheres==2){var f={left:b.createHemisphere(d.left,"left"),right:b.createHemisphere(d.right,"right"),num_hemisphere:2}}else{var f=b.createHemisphere(d,"filename");f.num_hemisphere=1}if(b.brainTransform==null){b.brainTransform=b.pack.createObject("Transform");if(d.num_hemispheres==2){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}}else{b.brainTransform.removeShape(b.brainTransform.shapes[0]);if(b.brainTransform.children[0]!=null){b.brainTransform.children[0].removeShape(b.brainTransform.children[0].shapes[0])}if(b.brainTransform.children[1]!=null){b.brainTransform.children[1].removeShape(b.brainTransform.children[1].shapes[0])}}if(d.num_hemispheres!=2){b.brainTransform.removeParam(b.brainTransform.children[0]);b.brainTransform.removeParam(b.brainTransform.children[1])}if(d.num_hemispheres==2&&b.brainHemisphereTransforms==null){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(f.num_hemisphere==1){b.brainTransform.addShape(f);f.createDrawElements(b.pack,null)}else{b.brainHemisphereTransforms.left.parent=b.brainTransform;b.brainHemisphereTransforms.right.parent=b.brainTransform;b.brainHemisphereTransforms.left.addShape(f.left);b.brainHemisphereTransforms.right.addShape(f.right);f.left.createDrawElements(b.pack,null);f.right.createDrawElements(b.pack,null)}b.model_data=d;if(b.afterCreateBrain!=undefined){b.afterCreateBrain(b.model_data)}};b.createLineObject=function(g,f,j){b.model_data=g;var c=b.createMaterial("/shaders/line.txt");var h=c.getParam("transAlpha");h.value=1;if(j){console.log("mesh")}var d=b.createLineShape(c,g,f,j);d.name=f;if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null);b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createPolygonObject=function(g,f){b.model_data=g;var c=b.createMaterial("/shaders/blinnphong.txt");c=b.blinnphongParams(c);if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(g.shapes){console.log("multi_shape");console.log(g);for(var h=0;h<g.shapes.length;h++){console.log(g.shapes[h]);var d=b.createPolygonShape(c,g.shapes[h]);d.name=g.shapes[h].name;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}}else{var d=b.createPolygonShape(c,g);d.name=f;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createHemisphere=function(j,f){var k=b.createMaterial("/shaders/blinnphong.txt");k=b.blinnphongParams(k);var s=b.pack.createObject("Shape");var p=b.pack.createObject("Primitive");var u=b.pack.createObject("StreamBank");p.material=k;p.owner=s;p.streamBank=u;s.name=f;p.primitiveType=b.o3d.Primitive.TRIANGLELIST;var d=b.pack.createObject("State");b.enableAlphaBlending(d);p.material.state=d;var m=b.pack.createObject("VertexBuffer");var o=m.createField("FloatField",3);if(!j.positionArray){alert("PositionArray nil");return false}m.set(j.positionArray);b.numberVertices=j.numberVertices;var t=(j.positionArray.length/3);p.numberVertices=b.numberVertices;if(!j.indexArray){alert("Index Array nil");return false}p.numberPrimitives=j.indexArray.length/3;var h=b.pack.createObject("IndexBuffer");h.set(j.indexArray);p.indexBuffer=h;var r=b.pack.createObject("VertexBuffer");var l=r.createField("FloatField",3);r.set(j.normalArray);var n=[];if(j.colorArray.length==4){for(var g=0;g<t;g++){n.push.apply(n,j.colorArray)}}else{n=j.colorArray}if(n.length<j.positionArray.length){alert("Problem with the colors: "+n.length)}var q=b.pack.createObject("VertexBuffer");var c=q.createField("FloatField",4);q.set(n);n=[];if(b.loading){jQuery(b.loading).html("Buffers Loaded")}u.setVertexStream(b.o3d.Stream.POSITION,0,o,0);u.setVertexStream(b.o3d.Stream.NORMAL,0,l,0);u.setVertexStream(b.o3d.Stream.COLOR,0,c,0);return s};b.createLineShape=function(p,h,z,c){var o=b.pack.createObject("Shape");var y=b.pack.createObject("StreamBank");o.name=z;if(!h.positionArray){alert("PositionArray nil");return false}b.numberVertices=h.numberVertices;var v=b.pack.createObject("Primitive");v.material=p;v.owner=o;v.streamBank=y;v.primitiveType=b.o3d.Primitive.LINELIST;var m=b.pack.createObject("State");b.enableAlphaBlending(m);v.material.state=m;var f=new Array();for(var u=0;u<h.nitems;u++){if(u==0){var l=0}else{var l=h.endIndicesArray[u-1]}f.push(h.indexArray[l]);for(var s=l+1;s<h.endIndicesArray[u]-1;s++){f.push(h.indexArray[s]);f.push(h.indexArray[s])}f.push(h.indexArray[h.endIndicesArray[u]-1])}if(!c){var g=b.pack.createObject("IndexBuffer");v.numberPrimitives=f.length/2;v.numberVertices=f.length;b.indexArray=f;var d=new Float32Array(f.length*3);for(var t=0;t<f.length;t++){d[t*3]=h.positionArray[f[t]*3];d[t*3+1]=h.positionArray[f[t]*3+1];d[t*3+2]=h.positionArray[f[t]*3+2]}var n=[];if(h.colorArray.length==4){for(var u=0;u<numberVertices;u++){n.push.apply(n,[0.5,0.5,0.7,1])}}else{n=new Float32Array(f.length*4);for(var t=0;t<f.length;t++){n[t*4]=h.colorArray[f[t]*4];n[t*4+1]=h.colorArray[f[t]*4+1];n[t*4+2]=h.colorArray[f[t]*4+2];n[t*4+3]=h.colorArray[f[t]*4+3]}}}else{console.log("mesh shape");v.numberVertices=h.meshPostionArray.length/3;v.numberPrimitives=v.numberVertices/2;var d=h.meshPositionArray;var n=h.meshColorArray}var w=b.pack.createObject("VertexBuffer");var q=w.createField("FloatField",3);w.set(d);y.setVertexStream(b.o3d.Stream.POSITION,0,q,0);if(n.length/4<d.length/3){alert("Problem with the colors: "+n.length)}var r=b.pack.createObject("VertexBuffer");var x=r.createField("FloatField",4);r.set(n);y.setVertexStream(b.o3d.Stream.COLOR,0,x,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}b.pack.gl.lineWidth(1);return o};b.createPolygonShape=function(p,g,G){var D=b.pack.createObject("Shape");var F=b.pack.createObject("StreamBank");D.name=G;if(!g.positionArray){alert("PositionArray nil");return false}b.numberVertices=g.numberVertices;var d=b.pack.createObject("Primitive");d.material=p;d.owner=D;d.streamBank=F;d.primitiveType=b.o3d.Primitive.TRIANGLELIST;var h=b.pack.createObject("State");b.enableAlphaBlending(h);d.material.state=h;if(g.nonindexed==undefined){var f=g.indexArray;d.numberPrimitives=f.length/3;d.numberVertices=f.length;b.indexArray=f;var c=new Float32Array(f.length*3);var B=new Array(f.length*3);var q=new Array(f.length*4);var A=new Float32Array(f.length*3);var n=f.length;for(var x=0;x<n;x++){c[x*3]=g.positionArray[f[x]*3];c[x*3+1]=g.positionArray[f[x]*3+1];c[x*3+2]=g.positionArray[f[x]*3+2];A[x*3]=g.normalArray[f[x]*3];A[x*3+1]=g.normalArray[f[x]*3+1];A[x*3+2]=g.normalArray[f[x]*3+2]}for(var w=0;w<n;w+=3){var z=[];z[0]=[g.positionArray[f[w]*3],g.positionArray[f[w]*3+1],g.positionArray[f[w]*3+2]];z[1]=[g.positionArray[f[w+1]*3],g.positionArray[f[w+1]*3+1],g.positionArray[f[w+1]*3+2]];z[2]=[g.positionArray[f[w+2]*3],g.positionArray[f[w+2]*3+1],g.positionArray[f[w+2]*3+2]];B.push.apply(B,z[0]);B.push.apply(B,z[1]);B.push.apply(B,z[1]);B.push.apply(B,z[2]);B.push.apply(B,z[2]);B.push.apply(B,z[0])}D.meshPositionArray=B}else{d.numberPrimitives=g.positionArray.length/3/3;d.numberVertices=g.positionArray.length/3;var c=new Float32Array(g.positionArray);var A=new Float32Array(g.normalArray);console.log(g)}var m=[];if(g.colorArray.length==4){for(var y=0;y<d.numberVertices;y++){m.push.apply(m,g.colorArray)}}else{m=new Float32Array(f.length*4);var n=f.length;for(var x=0;x<n;x++){m[x*4]=m[x*4+1]=g.colorArray[f[x]*4+1];m[x*4+2]=g.colorArray[f[x]*4+2];m[x*4+3]=g.colorArray[f[x]*4+3]}for(var u=0;u<indexArrayLenght;u+=3){var v=[];v[0]=[g.colorArray[f[x]*4],g.colorArray[f[x]*4+1],g.colorArray[f[x]*4+2],g.colorArray[f[x]*4+3]];v[1]=[g.colorArray[f[x+1]*4],g.colorArray[f[x+1]*4+1],g.colorArray[f[x+1]*4+2],g.colorArray[f[x+1]*4+3]];v[2]=[g.colorArray[f[x+2]*4],g.colorArray[f[x+2]*4+1],g.colorArray[f[x+2]*4+2],g.colorArray[f[x+2]*4+3]];q.push.apply(q,v[0]);q.push.apply(q,v[1]);q.push.apply(q,v[1]);q.push.apply(q,v[2]);q.push.apply(q,v[2]);q.push.apply(q,v[0])}}g.meshPositionArray=B;g.meshColorArray=q;var o=b.pack.createObject("VertexBuffer");var s=o.createField("FloatField",3);o.set(A);F.setVertexStream(b.o3d.Stream.NORMAL,0,s,0);var C=b.pack.createObject("VertexBuffer");var r=C.createField("FloatField",3);C.set(c);F.setVertexStream(b.o3d.Stream.POSITION,0,r,0);if(m.length<g.positionArray.length){alert("Problem with the colors: "+m.length)}var t=b.pack.createObject("VertexBuffer");var E=t.createField("FloatField",4);t.set(m);m=[];F.setVertexStream(b.o3d.Stream.COLOR,0,E,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}return D}}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.picking");o3djs.require("o3djs.arcball");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.scene");function BrainBrowser(){var h=this;bbObject(this);var f=new ColorManager();this.init=function(){o3djs.webgl.makeClients(h.initStep2)};this.initStep2=function(n){var o=n[0];h.o3dElement=o;h.client=o.client;h.o3d=o.o3d;h.math=o3djs.math;h.dragging=false;h.o3dWidth=-1;h.o3dHeight=-1;h.quaternions=o3djs.quaternions;h.lastRot=h.math.matrix4.identity();h.thatRot=h.math.matrix4.identity();h.zoomFactor=1.1;h.keyPressDelta=0.1;h.clock=0;h.timeMult=1;h.camera={farPlane:5000,nearPlane:0.1};h.object_origin=[0,0,0];h.loading=jQuery("#o3d_loading");o3djs.base.init(o);h.pack=h.client.createPack();var m=o3djs.rendergraph.createBasicView(h.pack,h.client.root,h.client.renderGraphRoot,[0.5,0.5,0.5,1]);h.viewInfo=m;m.drawContext.projection=h.math.matrix4.perspective(h.math.degToRad(30),h.client.width/h.client.height,1,5000);h.eyeView=[0,0,500];m.drawContext.view=h.math.matrix4.lookAt(h.eyeView,[0,0,0],[0,1,0]);h.aball=o3djs.arcball.create(100,100);h.client.setRenderCallback(h.renderCallback);jQuery("body").keydown(h.keyPressedCallback);o3djs.event.addEventListener(o,"wheel",h.scrollMe);h.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");jQuery("#screenshot").click(function(p){jQuery(this).attr("href",bb.client.toDataURL())});if(h.afterInit){h.afterInit(h)}window.onresize();h.updateInfo()};this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(m){h.setClientSize();if(h.autoRotate){h.clock=0;h.clock+=m.elapsedTime*h.timeMult;if(h.autoRotate.x){h.brainTransform.rotateX(0.1*h.clock)}if(h.autoRotate.y){h.brainTransform.rotateY(0.1*h.clock)}if(h.autoRotate.z){h.brainTransform.rotateZ(0.1*h.clock)}}};this.createMaterial=function(m){var o=h.pack.createObject("Effect");var p=h.loadCombinedShaderFromUrl(m);o.loadFromFXString(p);var n=h.pack.createObject("Material");n.drawList=h.viewInfo.performanceDrawList;n.effect=o;o.createUniformParameters(n);return n};function d(m){m.getStateParam("AlphaBlendEnable").value=true;m.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;m.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;m.getStateParam("AlphaTestEnable").value=true;m.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER}h.enableAlphaBlending=d;this.clearScreen=function(){if(brainbrowser.brainTransform!=undefined){if(brainbrowser.brainTransform.shapes!=undefined){var m=brainbrowser.brainTransform.shapes.length;for(var n=0;n<m;n++){brainbrowser.brainTransform.removeShape(brainbrowser.brainTransform.shapes[0])}}if(brainbrowser.brainTransform.children.length){var o=brainbrowser.brainTransform.children.length;for(var n=0;n<o;n++){var m=brainbrowser.brainTransform.children[n].length;brainbrowser.brainTransform.children[n].removeShape(brainbrowser.brainTransform.children[n].shapes[0])}}if(h.afterClearScreen!=undefined){h.afterClearScreen()}}};this.displayObjectFile=function(n,m){if(n.objectClass=="P"&&n.numberVertices==81924){h.createBrain(n,m)}else{if(n.objectClass=="P"){h.createPolygonObject(n,m)}else{if(n.objectClass=="L"){h.createLineObject(n,m)}else{alert("Object file not supported")}}}if(h.afterDisplayObject!=undefined){h.afterDisplayObject(h.brainTransform)}};function c(o,m,n){if(n==null){n=h.model_data.data}if(n.fixRange==false||n.fixRange==null){n.rangeMin=o;n.rangeMax=m}}this.updateClearColor=function(m){h.viewInfo.clearBuffer.clearColor=m};this.updateClearColorFromName=function(m){if(m=="white"){h.updateClearColor([1,1,1,1])}else{if(m=="black"){h.updateClearColor([0,0,0,1])}else{if(m=="pink"){h.updateClearColor([1,0,1,1])}else{h.updateClearColor([0.5,0.5,0.5,1])}}}};this.blinnphongParams=function(r){var s=r.getParam("transAlpha");s.value=1;var w=r.getParam("lightWorldPos");w.value=h.eyeView;var m=r.getParam("ambient");var q=r.getParam("ambientIntensity");var p=r.getParam("lightIntensity");var u=r.getParam("specular");var t=r.getParam("emissive");var n=r.getParam("colorMult");var v=r.getParam("wires");v.value=false;m.value=[0.04,0.04,0.04,1];q.value=[1,1,1,1];p.value=[0.8,0.8,0.8,1];u.value=[0.5,0.5,0.5,1];t.value=[0,0,0,1];n.value=[1,1,1,1];var o=r.getParam("shininess");o.value=10000;return r};this.resetView=function(){h.brainTransform.children[0].visible=true;h.brainTransform.children[1].visible=true;h.brainTransform.identity();h.brainTransform.children[0].identity();h.brainTransform.children[1].identity()};this.setupView=function(m){h.resetView();if(h.model_data&&h.model_data.num_hemispheres==2){var n=h.getViewParams();switch(n.view){case"superior":h.superiorView();break;case"medial":h.medialView();break;case"anterior":h.anteriorView();break;case"inferior":h.inferiorView();break;case"lateral":h.lateralView();break;case"posterior":h.posteriorView();break;default:h.superiorView();break}}if(n.left==true){h.leftHemisphereVisible(true)}else{h.leftHemisphereVisible(false)}if(n.right==true){h.rightHemisphereVisible(true)}else{h.rightHemisphereVisible(false)}h.thatRot=h.math.matrix4.mul(h.brainTransform.localMatrix,h.math.matrix4.identity())};this.leftHemisphereVisible=function(m){h.brainTransform.children[0].visible=m};this.rightHemisphereVisible=function(m){h.brainTransform.children[1].visible=m};this.medialView=function(m){if(h.model_data.num_hemispheres==2){h.brainTransform.children[0].translate([-100,0,0]);h.brainTransform.children[1].translate([100,0,0]);h.brainTransform.children[0].rotateZ(h.math.degToRad(-90));h.brainTransform.children[1].rotateZ(h.math.degToRad(90));h.brainTransform.rotateX(h.math.degToRad(-90))}};this.lateralView=function(m){if(h.model_data.num_hemispheres==2){h.brainTransform.children[0].translate([-100,0,0]);h.brainTransform.children[1].translate([100,0,0]);h.brainTransform.children[0].rotateZ(h.math.degToRad(-90));h.brainTransform.children[1].rotateZ(h.math.degToRad(90));h.brainTransform.rotateX(h.math.degToRad(90));h.brainTransform.rotateY(h.math.degToRad(180))}};this.superiorView=function(){};this.inferiorView=function(){h.brainTransform.rotateY(h.math.degToRad(180))};this.anteriorView=function(m){h.resetView();h.brainTransform.rotateX(h.math.degToRad(-90));h.brainTransform.rotateZ(h.math.degToRad(180))};this.posteriorView=function(m){h.resetView();h.brainTransform.rotateX(h.math.degToRad(-90))};this.separateHemispheres=function(m){if(h.model_data.num_hemispheres==2){this.brainTransform.children[0].translate([-1,0,0]);this.brainTransform.children[1].translate([1,0,0])}};this.setClientSize=function(){var n=parseInt(h.client.width);var m=parseInt(h.client.height);if(n!=h.o3dWidth||m!=h.o3dHeight){h.o3dWidth=n;h.o3dHeight=m;h.updateProjection();h.aball.setAreaSize(h.o3dWidth,h.o3dHeight)}};this.ZoomInOut=function(n){for(var m=0;m<h.eyeView.length;m+=1){h.eyeView[m]=h.eyeView[m]/n}h.viewInfo.drawContext.view=h.math.matrix4.lookAt(h.eyeView,[0,0,0],[0,1,0])};h.scrollMe=function(n){var m=(n.deltaY<0)?1/h.zoomFactor:h.zoomFactor;h.ZoomInOut(m);h.client.render()};function j(m){l();if(m){h.selectedInfo=m}}this.updateInfo=function(){if(!h.treeInfo){h.treeInfo=o3djs.picking.createPickManager(h.client.root)}h.treeInfo.update()};function l(){if(h.selectedInfo){h.highlightShape=null;h.selectedInfo=null}}this.click=function(s,p){var o=o3djs.picking.clientPositionToWorldRay(s.x,s.y,h.viewInfo.drawContext,h.client.width,h.client.height);l();h.treeInfo.update();var q=h.treeInfo.pick(o);if(q){j(q);var u=q.rayIntersectionInfo.primitiveIndex;var r=q.rayIntersectionInfo.position;var m=q.element.owner.name;var t=h.model_data.get_vertex(u,r,m);var n={ray_position:r,position_vector:t.position_vector,element:q.element,hemisphere:m,vertex:t.vertex};return p(s,n)}else{jQuery(h.pickInfoElem).html("--nothing--")}return false};this.getInfoForVertex=function(m){return h.model_data.getVertexInfo(m)};function k(n){var m;var o;if(n.pageX!=undefined&&n.pageY!=undefined){m=n.pageX;o=n.pageY}else{m=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;o=n.clientY+document.body.scrollTop+document.documentElement.scrollTop}m-=h.o3dElement.offsetLeft;o-=h.o3dElement.offsetTop;return{x:m,y:o}}this.startDragging=function(n){if(n.button==h.o3d.Event.BUTTON_RIGHT){var m=k(n);h.startPosition=o3djs.picking.clientPositionToWorldRay(m.x,m.y,h.viewInfo.drawContext,h.client.height,h.client.width).far;h.dragging=true}else{if(n.shiftKey&&n.ctrlKey&&h.model_data.num_hemispheres==2){h.drag_hemisphere=click(n,function(o,p){if(p.hemisphere=="left"){return 0}else{if(p.hemisphere=="right"){return 1}else{return false}}})}h.lastRot=h.thatRot;h.aball.click([n.x,n.y]);h.dragging=true}};this.drag=function(t){if(h.dragging&&t.button==h.o3d.Event.BUTTON_LEFT){var p=h.aball.drag([t.x,t.y]);var o=h.quaternions.quaternionToRotation(p);h.thatRot=h.math.matrix4.mul(h.lastRot,o);if(h.drag_hemisphere===0||h.drag_hemisphere===1){var n=h.brainTransform.children[h.drag_hemisphere].localMatrix;h.math.matrix4.setUpper3x3(n,h.thatRot);h.brainTransform.children[h.drag_hemisphere].localMatrix=n}else{var n=h.brainTransform.localMatrix;h.math.matrix4.setUpper3x3(n,h.thatRot);h.brainTransform.localMatrix=n}}else{if(h.dragging&&t.button==h.o3d.Event.BUTTON_RIGHT){var s=k(t);var r=o3djs.picking.clientPositionToWorldRay(s.x,s.y,h.viewInfo.drawContext,h.client.height,h.client.width).far;u=[0,0,0];var q=h.eyeView[0];var u=[(r[0]-h.startPosition[0])/5000*h.eyeView[2],(r[1]-h.startPosition[1])/5000*h.eyeView[2],0];h.startPosition=r;h.brainTransform.translate(u)}else{if(h.dragging){h.stopDragging(t)}}}};this.stopDragging=function(m){h.drag_hemisphere=false;h.dragging=false};this.updateCamera=function(){var m=[0,1,0];h.viewInfo.drawContext.view=h.math.matrix4.lookAt(h.camera.eye,h.camera.target,m);h.lightPosParam.value=h.camera.eye};this.updateProjection=function(){h.viewInfo.drawContext.projection=h.math.matrix4.perspective(h.math.degToRad(45),h.o3dWidth/h.o3dHeight,h.camera.nearPlane,h.camera.farPlane)};this.keyPressedAction=function(m,o){var n=false;switch(m){case"&":h.ZoomInOut(h.zoomFactor);n="zoom_in";break;case"(":h.ZoomInOut(1/h.zoomFactor);n="zoom_out";break;case" ":h.separateHemispheres();n="separate";break}return n};this.keyPressedCallback=function(n){var m=false;switch(n.which){case 38:h.ZoomInOut(h.zoomFactor);m="ZoomIn";break;case 40:h.ZoomInOut(1/h.zoomFactor);m="ZoomOut";break;case 32:h.separateHemispheres();m="Seperate";break}if(m){return false}else{return true}};this.set_fill_mode_wireframe=function(){if(h.model_data.num_hemispheres==2){var m=h.brainTransform.children[0].shapes[0].elements[0].material;h.state=h.pack.createObject("State");m.state=h.state;var n=m.getParam("wires");n.value=true;h.state.getStateParam("FillMode").value=h.o3d.State.WIREFRAME;m=h.brainTransform.children[1].shapes[0].elements[0].material;m.state=h.state;n=m.getParam("wires");n.value=true}else{h.brainTransform.children[0].visible=false;h.createLineObject(h.model_data,"mesh",true)}h.client.render()};this.set_fill_mode_solid=function(){if(h.model_data.num_hemispheres==2){var m=h.brainTransform.children[0].shapes[0].elements[0].material;h.state1=h.pack.createObject("State");m.state=h.state1;var n=m.getParam("wires");n.value=false;h.state.getStateParam("FillMode").value=h.o3d.State.SOLID;m=h.brainTransform.children[1].shapes[0].elements[0].material;m.state=h.state;var n=m.getParam("wires");n.value=false}else{var m=h.brainTransform.shapes[0].elements[0].material;h.state=h.pack.createObject("State");m.state=h.state;h.state.getStateParam("FillMode").value=h.o3d.State.SOLID;var n=m.getParam("wires");n.value=false}};function b(m,n,o){jQuery.ajax({type:"GET",url:m,dataType:"text",success:function(p){o(p)},error:function(p,r,q){alert("Failure: "+r)},data:{},async:n,timeout:100000})}function a(p,o){var m=new FileReader();var n=p.files;m.file=n[0];m.onloadend=function(q){o(q.target.result)};m.readAsText(n[0])}this.loadObjFromUrl=function(m){b(m,false,function(o){var p=m.split("/");var n=p[p.length-1];h.displayObjectFile(new MNIObject(o),n)})};this.loadWaveformObjFromUrl=function(m){b(m,false,function(o){var p=m.split("/");var n=p[p.length-1];h.displayObjectFile(new WaveformObj(o),n)})};this.loadObjFromFile=function(m){a(m,function(n){var p=m.value.split("\\");var o=p[p.length-1];h.displayObjectFile(new MNIObject(n),o)})};this.loadSpectrumFromUrl=function(m){b(m,true,function(o){var n=new Spectrum(o);h.spectrum=n;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(n)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};this.loadSpectrumFromFile=function(m){a(m,function(o){var n=new Spectrum(o);h.spectrum=n;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(n)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};function g(m){}this.loadDataFromFile=function(s){var m=s.files[0].name;var q=function(u){var t=new Data(u);t.fileName=m;if(t.values.length<h.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+t.values.length);return -1}else{h.model_data.data=t}c(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null};if(m.match(/.*.mnc|.*.nii/)){var r=new XMLHttpRequest();if(m.match(/.*.mnc/)){r.open("POST","/minc/volume_object_evaluate",false)}else{r.open("POST","/nii/volume_object_evaluate",false)}var o=document.getElementById("datafile-form");var p=new FormData(o);r.send(p);var n=r.response;q(n)}else{a(s,q)}};this.loadSeriesDataFromFile=function(r){console.log(r.files.length);var q=r.files.length;h.seriesData=new Array(q);h.seriesData.numberFiles=q;var o=r.files;for(var n=0;n<q;n++){var m=new FileReader();m.file=o[n];var p=m.onloadend=(function(t,s){return function(u){console.log(u.target.result.length);console.log(s);h.seriesData[s]=new Data(u.target.result);h.seriesData[s].fileName=t.name}})(m.file,n);m.readAsText(o[n])}h.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var m=$("#series");$('<span id="series-value">0</span>').appendTo(m);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:h.seriesData.numberFiles-1,step:0.1,slide:function(n,o){if(o.value-Math.floor(o.value)<0.01){h.model_data.data=h.seriesData[o.value]}else{if(h.seriesData[0].fileName.match("pval.*")){h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(o.value)],h.seriesData[Math.floor(o.value)+1],(o.value-Math.floor(o.value)),true))}else{h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(o.value)],h.seriesData[Math.floor(o.value)+1],(o.value-Math.floor(o.value))))}}if(h.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(o.value*3+5).toFixed(1))}else{if(h.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(o.value*1+10))}}$(m).children("#series-value").html(o.value);if(h.model_data.data.values.length<h.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+h.model_data.data.values.length);return -1}c(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null}}).appendTo(m)};this.loadBlendDataFromFile=function(r){var q=r.files.length;h.blendData=new Array(q);h.blendData.numberFiles=q;var o=r.files;for(var n=0;n<q;n++){var m=new FileReader();m.file=o[n];var p=m.onloadend=(function(t,s){return function(v){h.blendData[s]=new Data(v.target.result);h.blendData.alpha=1/q;h.blendData[s].fileName=t.name;for(var u=0;u<2;u++){if(h.blendData[u]==undefined){console.log("not done yet");return}}c(h.blendData[0].values.min(),h.blendData[0].values.max(),h.blendData[0]);c(h.blendData[1].values.min(),h.blendData[1].values.max(),h.blendData[1]);if(h.afterLoadData!=null){h.afterLoadData(null,null,h.blendData,true)}h.blend($(".blend_slider").slider("value"))}})(m.file,n);m.readAsText(o[n])}h.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+h.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var m=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(m);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(n,o){h.blend($(this).slider("value"))}}).appendTo(m)};this.blend=function(n){h.blendData[0].alpha=n;h.blendData[1].alpha=1-n;for(var m=2;m<h.blendData.length;m++){h.blendData[m].alpha=0}h.updateColors(h.blendData,null,null,h.spectrum,h.flip,h.clamped,true)};this.loadDataFromUrl=function(n,m){b(n,true,function(p,o){h.model_data.data=new Data(p);h.model_data.data.fileName=m;c(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=undefined){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum)})};this.loadCombinedShaderFromUrl=function(m){var n;b(m,false,function(o){n=o});return n};this.updateColors=function(I,A,C,G,q,y,B,o){h.clamped=y;if(B){var H=f.blendColorMap(G,I,0,1)}else{var H=I.createColorArray(A,C,G,q,y,h.model_data.colorArray,h.model_data)}if(h.model_data.num_hemispheres==2){var n=H.slice(0,H.length/2);var x=H.slice(H.length/2,H.length);var u=h.pack.createObject("VertexBuffer");var E=u.createField("FloatField",4);u.set(n);var s=h.brainTransform.children[0].shapes[0];var w=s.elements[0].streamBank;w.setVertexStream(h.o3d.Stream.COLOR,0,E,0);var D=h.pack.createObject("VertexBuffer");var r=D.createField("FloatField",4);D.set(x);var F=h.brainTransform.children[1].shapes[0];var m=F.elements[0].streamBank;m.setVertexStream(h.o3d.Stream.COLOR,0,r,0);h.client.render()}else{var v=h.pack.createObject("VertexBuffer");var z=v.createField("FloatField",4);v.set(H.nonIndexedColorArray);var p=h.brainTransform.shapes[0];console.log(p);var t=p.elements[0].streamBank;t.setVertexStream(h.o3d.Stream.COLOR,0,z,0);h.client.render()}if(h.afterUpdateColors!=null){h.afterUpdateColors(I,A,C,G)}return 1};this.rangeChange=function(n,m,o){h.model_data.data.rangeMin=n;h.model_data.data.rangeMax=m;h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,o);if(h.afterRangeChange!=null){h.afterRangeChange(n,m)}};this.changeShapeTransparency=function(p,q){var n=null;if(h.brainTransform.shapes!=undefined){for(var o=0;o<h.brainTransform.shapes.length;o++){if(h.brainTransform.shapes[o].name==p){n=h.brainTransform.shapes[o]}}}for(var m=0;m<h.brainTransform.children.length;m++){for(var o=0;o<h.brainTransform.children[m].shapes.length;o++){if(h.brainTransform.children[m].shapes[o].name==p){n=h.brainTransform.children[m].shapes[o]}}}if(n){n.elements[0].material.getParam("transAlpha").value=q}};this.getImageUrl=function(){var p=document.createElement("canvas");var m=document.getElementById("spectrum_canvas");p.width=h.o3dElement.width;p.height=h.o3dElement.height;var q=p.getContext("2d");var n=new Image();function o(){var r=new Image();r.onload=function(){q.drawImage(r,0,0);window.open(p.toDataURL(),"screenshot")};r.src=m.toDataURL()}n.onload=function(){q.drawImage(n,0,0);o()};n.src=h.o3dElement.toDataURL()};window.onresize=function(){h.client.height=window.innerHeight;h.viewInfo.drawContext.projection=h.math.matrix4.perspective(h.math.degToRad(30),h.client.width/h.client.height,1,5000)};h.init()}var brainbrowser;function SurfView(a){var b=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,100,null);d.id="spectrum_canvas";var f=document.getElementById("color_bar");if(!f){jQuery('<div id="color_bar"></div>').html(d).appendTo("#data-range")}else{jQuery(f).html(d)}brainbrowser.spectrumObj=c};brainbrowser.afterDisplayObject=function(f){$("#shapes").html("");if(f.shapes!=undefined){for(var g=0;g<f.shapes.length;g++){var d=f.shapes[g];$('<div id="shape_'+g+'" data-shape-name="'+d.name+'" class="shape"><h4>Shape '+(g+1)+"</h4>Name: "+d.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+d.name+"></div></div>").appendTo("#shapes")}}if(f.children.length>0){for(var c=0;c<f.children.length;c++){for(var g=0;g<f.children[c].shapes.length;g++){var d=f.children[c].shapes[g];$('<div id="shape_'+g+'" data-shape-name="'+d.name+'" class="shape"><h4>Shape '+(g+1)+"</h4>Name: "+d.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+d.name+"></div></div>").appendTo("#shapes")}}}brainbrowser.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:0,max:100,slide:function(h,k){var j=$(h.target).attr("data-shape-name");var l=$(h.target).slider("value")/100;brainbrowser.changeShapeTransparency(j,l)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(c,f,d){jQuery("#x-coord").val(c[0]);jQuery("#y-coord").val(c[1]);jQuery("#z-coord").val(c[2]);jQuery("#v-coord").val(f);jQuery("#value-coord").val(d)};brainbrowser.afterInit=function(f){f.clamped=true;f.flip=false;f.clearScreen();if(typeof a=="string"&&a!=""){f.loadObjFromUrl(a)}else{if(typeof a=="function"){console.log("loading models");a(f)}}jQuery("body").keydown(f.keyPressedCallback);o3djs.event.addEventListener(f.o3dElement,"mousedown",function(g){if(g.shiftKey){f.click(g,function(j,h){if(brainbrowser.data){b.updateCoordinates(h.position_vector,h.vertex,brainbrowser.data.values[h.vertex])}})}else{f.startDragging(g)}});o3djs.event.addEventListener(f.o3dElement,"mousemove",function(g){f.drag(g)});o3djs.event.addEventListener(f.o3dElement,"mouseup",function(g){if(!g.shiftKey||g.button==f.o3d.Event.BUTTON_RIGHT){f.stopDragging(g)}});$(f.o3dElement).bind("contextmenu",function(g){return false});jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(j,k){var h=parseFloat(k.values[0]);var g=parseFloat(k.values[1]);f.rangeChange(h,g,$("#clamp_range").attr("checked"))},step:0.1});f.afterRangeChange=function(j,g){jQuery("#data-range-min").val(j);jQuery("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(j,g,null);h.id="spectrum_canvas";jQuery("#color_bar").html(jQuery(h))};function d(m){var g=$("#data-range");$(g).html("");var l='<div id="data_range_multiple"><ul>';if(!m.length){var m=[m]}for(var j=0;j<m.length;j++){l+='<li><a href="#data_file'+j+'">'+m[j].fileName+"</a></li>"}l+="</ul>";for(var h=0;h<m.length;h++){l+='<div id="data_file'+h+'" class="box full_box"><h4>Thresholding</h4>Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br /><div id="range-slider+'+h+'" data-blend-index="'+h+'" class="slider"></div>Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" ><input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label><input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label><input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label></div>'}l+="</div>";$(g).html(l);$(g).tabs();$("#data_range").find(".slider").each(function(k,o){$(o).slider({range:true,min:m[0].values.min(),max:m[0].values.max(),values:[m[k].rangeMin,m[k].rangeMax],step:0.1,slide:function(q,r){var p=$(this).attr("data-blend-index");m[0].rangeMin=r.values[0];m[0].rangeMax=r.values[1];f.model_data.data=m[0];f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped,false);f.rangeChange(m[0].rangeMin,m[0].rangeMax,f.clamped)}})});function n(p){var o=$("#data-range-min").val();var k=$("#data-range-max").val();jQuery(p.target).siblings(".slider").slider("values",0,o);jQuery(p.target).siblings(".slider").slider("values",1,k);f.rangeChange(o,k,$(p.target).siblings("#clamp_range").attr("checked"))}jQuery("#data-range-min").change(n);jQuery("#data-range-max").change(n);jQuery("#fix_range").click(function(k,o){f.fixRange=jQuery(e.target).attr("checked")});jQuery("#clamp_range").change(function(p){var o=parseFloat($(p.target).siblings("#data-range-min").val());var k=parseFloat($(p.target).siblings("#data-range-max").val());if($(p.target).attr("checked")==true){f.rangeChange(o,k,true)}else{f.rangeChange(o,k,false)}});jQuery("#flip_range").change(function(k){f.flip=$(k.target).attr("checked");f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,brainbrowser.spectrum,f.flip,f.clamped)})}f.afterLoadData=function(j,h,k,g){if(g){d(k)}else{d(k);jQuery("#range-slider").slider("values",0,parseFloat(j));jQuery("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(j,h)}};jQuery("#meshmode").change(function(g){if(jQuery(g.target).attr("checked")==true){f.set_fill_mode_wireframe()}else{f.set_fill_mode_solid()}});jQuery("#clearshapes").click(function(g){brainbrowser.clearScreen()});jQuery("#openImage").click(function(g){brainbrowser.getImageUrl()});function c(g){if($("#autorotate").attr("checked")){f.autoRotate={};f.autoRotate.x=$("#autorotateX").attr("checked");f.autoRotate.y=$("#autorotateY").attr("checked");f.autoRotate.z=$("#autorotateZ").attr("checked")}else{f.autoRotate=false}}jQuery("#autorotate-controls").children().change(c);jQuery("#autorotate").change(c);jQuery(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});jQuery("#clearColor").change(function(h){var g=$(h.target).val();f.updateClearColorFromName(g)});$("#examples").click(function(h){var g=$(h.target).attr("data-example-name");switch(g){case"basic":f.clearScreen();f.loadObjFromUrl("/models/surf_reg_model_both.obj");f.eyeView[2]=500;f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0]);f.setupView();break;case"punkdti":f.clearScreen();f.loadObjFromUrl("/models/dti.obj");f.loadObjFromUrl("/models/left_color.obj");f.loadObjFromUrl("/models/right_color.obj");f.eyeView[2]=500;f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0]);f.setupView();break;case"realct":f.clearScreen();f.loadObjFromUrl("/models/realct.obj");f.loadDataFromUrl("/models/realct.txt","cortical thickness");f.eyeView[2]=500;f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0]);f.setupView();break;case"car":f.clearScreen();f.loadWaveformObjFromUrl("/models/car.obj");f.eyeView[2]=62;f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0]);f.brainTransform.localMatrix=[0.42618776159231875,0.37186445186747336,-0.8246701287825527,0,-0.9043269714016714,0.15135489203623487,-0.3991045294809117,0,-0.023594928785854036,0.9158649060281773,0.4007926561722248,0,0,0,0,1];f.thatRot=f.math.matrix4.mul(f.brainTransform.localMatrix,f.math.matrix4.identity());break;case"plane":f.clearScreen();f.updateClearColorFromName("black");f.loadObjFromUrl("/models/dlr_bigger.streamlines.obj");f.loadObjFromUrl("/models/dlr.model.obj");f.eyeView[2]=32;f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0]);f.brainTransform.localMatrix=[0.5175565260543228,0.2198608202734916,-0.8269198643443321,0,-0.7683778894163086,0.5446338685327888,-0.33610916129012,0,0.3764713287817814,0.8093424299736646,0.45081500601644064,0,0,0,0,1];f.thatRot=f.math.matrix4.mul(f.brainTransform.localMatrix,f.math.matrix4.identity())}return false})}};