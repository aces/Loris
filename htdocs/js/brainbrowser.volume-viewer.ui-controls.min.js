/*
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/*
* BrainBrowser v1.4.2
* https://brainbrowser.cbrain.mcgill.ca/
*
* Author: Tarek Sherif  <tsherif@gmail.com> (http://tareksherif.ca/)
* Author: Nicolas Kassis
*/
BrainBrowser.VolumeViewer.modules.uiControls=function(a){"use strict";var b=BrainBrowser.VolumeViewer;a.globalUIControls=function(b){var c,d,e=$('<div id="global-controls" class="volume-viewer-controls"></div>');a.volumes.length>1&&(c=$('<input type="checkbox" class="button" id="sync"><label for="sync">Sync Volumes</label>'),c.change(function(){a.synced=c.is(":checked")}),e.append(c)),d=$('<span id="capture" class="button">Capture Slices</span>'),d.click(function(){var b=a.displays[0][0].canvas.width,c=a.displays[0][0].canvas.height,d=a.active_canvas,e=document.createElement("canvas"),f=e.getContext("2d"),g=new Image;e.width=b*a.displays.length,e.height=3*c,f.fillStyle="#000000",f.fillRect(0,0,e.width,e.height),a.active_canvas=null,a.draw(),a.displays.forEach(function(a,d){a.forEach(function(a,e){f.drawImage(a.canvas,d*b,e*c)})}),a.active_canvas=d,a.draw(),g.onload=function(){$("<div></div>").append(g).dialog({title:"Slices",height:g.height,width:g.width})},g.src=e.toDataURL()}),e.append(d),$(b).append(e)},a.volumeUIControls=function(b,c,d){b=$(b),a.coordinateUI(b,c,d),"multivolume"===c.type?a.blendUI(b,c,d):(a.colorScaleUI(b,c,d),a.thresholdUI(b,c,d),c.data.time&&a.timeUI(b,c,d),a.sliceSeriesUI(b,c,d))},a.coordinateUI=function(b,c,d){var e,f,g;if(c.getWorldCoords){e=$('<div class="coords"></div>'),f=$('<div class="control-heading" id="world-coordinates-heading'+d+'">World Coordinates: </div>'+'<div class="world-coords">'+'X:<input id="world-x" class="control-inputs"></input>'+'Y:<input id="world-y" class="control-inputs"></input>'+'Z:<input id="world-z" class="control-inputs"></input>'+"</div>");var h={x:f.find("#world-x"),y:f.find("#world-y"),z:f.find("#world-z")};f.change(function(){var b=parseFloat(h.x.val()),d=parseFloat(h.y.val()),e=parseFloat(h.z.val());BrainBrowser.utils.isNumeric(b)||(b=0),BrainBrowser.utils.isNumeric(d)||(d=0),BrainBrowser.utils.isNumeric(e)||(e=0),c.setWorldCoords(b,d,e),a.redrawVolumes()}),g=$('<div class="control-heading" id="voxel-coordinates-heading'+d+'">Voxel Coordinates: </div>'+'<div class="voxel-coords">'+'X:<input id="voxel-x" class="control-inputs"></input>'+'Y:<input id="voxel-y" class="control-inputs"></input>'+'Z:<input id="voxel-z" class="control-inputs"></input>'+"</div>");var i={x:g.find("#voxel-x"),y:g.find("#voxel-y"),z:g.find("#voxel-z")};g.change(function(){var b=parseInt(i.x.val(),10),d=parseInt(i.y.val(),10),e=parseInt(i.z.val(),10);BrainBrowser.utils.isNumeric(b)||(b=0),BrainBrowser.utils.isNumeric(d)||(d=0),BrainBrowser.utils.isNumeric(e)||(e=0),c.setVoxelCoords(b,d,e),a.redrawVolumes()}),a.addEventListener("sliceupdate",function(){var a=c.getWorldCoords(),b=c.getVoxelCoords();h.x.val(a.x.toPrecision(6)),h.y.val(a.y.toPrecision(6)),h.z.val(a.z.toPrecision(6)),i.x.val(b.x.toPrecision(6)),i.y.val(b.y.toPrecision(6)),i.z.val(b.z.toPrecision(6))})}e.append(f),e.append(g),b.append(e)},a.blendUI=function(b,c,d){var e=$('<div id="blend-slider" class="slider volume-viewer-blend"></div>'),f=$('<div class="control-heading" id="blend-heading'+d+'">Blend (-50 to 50): </div>'),g=$('<input class="control-inputs" value="0" id ="blend-val"/>');f.append(g),f.append(e),b.append(f),e.slider({min:-50,max:50,step:1,slide:function(b,d){var e=parseInt(d.value,10);c.updateBlendRatio(e),a.redrawVolumes(),g.val(e)},stop:function(){$(this).find("a").blur()}}),g.change(function(){var b=parseFloat(this.value);BrainBrowser.utils.isNumeric(b)||(b=0),b=Math.max(-50,Math.min(b,50)),this.value=b,e.slider("value",b),c.updateBlendRatio(b),a.redrawVolumes()})},a.colorScaleUI=function(c,d,e){var f=$("<select></select>"),g="";b.colorScales.forEach(function(b,c){g+='<option value="'+c+'"'+(a.defaultScale===b?" SELECTED":"")+">"+b.name+"</option>"}),f.html(g),f.change(function(c){d.colorScale=b.colorScales[+$(c.target).val()],a.redrawVolumes()}),c.append($('<div class="control-heading" id="color-scale-heading'+e+'" >Color Scale: </div>').append(f))},a.thresholdUI=function(b,c,d){var e=$('<div class="slider volume-viewer-threshold" id="threshold-slider'+d+'"></div>'),f=$('<div class="control-heading" class="slider-div">Threshold: </div>'),g=$('<input class="control-inputs thresh-input-left" value="0"/>'),h=$('<input class="control-inputs thresh-input-right" value="255"/>'),i=$('<div class="thresh-inputs"></div>');i.append(g).append(h),f.append(i),b.append(f),f.append(e),e.slider({range:!0,min:0,max:255,values:[0,255],step:1,slide:function(b,d){var e=d.values;c.min=e[0],c.max=e[1],a.redrawVolumes(),g.val(e[0]),h.val(e[1])},stop:function(){$(this).find("a").blur()}}),g.change(function(){var b=parseFloat(this.value);BrainBrowser.utils.isNumeric(b)||(b=0),b=Math.max(0,Math.min(b,255)),this.value=b,e.slider("values",0,b),c.min=b,a.redrawVolumes()}),h.change(function(){var b=parseFloat(this.value);BrainBrowser.utils.isNumeric(b)||(b=255),b=Math.max(0,Math.min(b,255)),this.value=b,e.slider("values",1,b),c.max=b,a.redrawVolumes()})},a.timeUI=function(b,c,d){var e,f=$('<div class="control-heading" class="slider-div">Time: </div>'),g=$('<div class="slider volume-viewer-threshold" id="threshold-time-slider'+d+'"></div>'),h=$('<input class="control-inputs" value="0" id ="time-val"/>'),i=$('<input type="checkbox" class="button" id="play-'+d+'"><label for="play-'+d+'">Play</label>'),j=0,k=c.data.time.space_length-1;g.slider({min:j,max:k,value:0,step:1,slide:function(b,d){var e=+d.value;h.val(e),c.current_time=e,a.redrawVolumes()},stop:function(){$(this).find("a").blur()}}),h.change(function(){var b=parseInt(this.value,10);BrainBrowser.utils.isNumeric(b)||(b=0),b=Math.max(j,Math.min(b,k)),this.value=b,h.val(b),g.slider("value",b),c.current_time=b,a.redrawVolumes()}),i.change(function(){i.is(":checked")?(clearInterval(e),e=setInterval(function(){var b=c.current_time+1;b=b>k?0:b,c.current_time=b,h.val(b),g.slider("value",b),a.redrawVolumes()},200)):clearInterval(e)}),f.append(h),f.append(g),b.append(f),b.append(i)},a.sliceSeriesUI=function(a,b,c){var d=$('<div class="control-heading" id="slice-series-heading'+c+'">All slices: </div>'),e=$('<div id="slice-series-buttons'+c+'"></div>'),f=$('<span class="slice-series button" data-axis="xspace" style="font-size: 11px">Sagittal</span>'),g=$('<span class="slice-series button" data-axis="yspace" style="font-size: 11px">Coronal</span>'),h=$('<span class="slice-series button" data-axis="zspace" style="font-size: 11px">Transverse</span>'),i={xspace:"Sagittal",yspace:"Coronal",zspace:"Transverse"};e.append(f),e.append(g),e.append(h),e.find(".slice-series").click(function(){var a,c,d,e=$(this).data("axis"),f=b.data[e],g=f.space_length,h=b.current_time,j=10,k=.5,l=document.createElement("canvas"),m=l.getContext("2d"),n=b.slice(e,0,h).getImage(k),o=new Image;for(l.width=j*n.width,l.height=(g/j+1)*n.height,m.fillStyle="#000000",m.fillRect(0,0,l.width,l.height),a=0;g>a;a++)n=b.slice(e,a,h).getImage(k),c=a%j*n.width,d=Math.floor(a/j)*n.height,m.putImageData(n,c,d);o.onload=function(){$("<div></div>").append(o).dialog({title:i[e]+" Slices",height:600,width:o.width})},o.src=l.toDataURL()}),a.append(d),a.append(e)}};