/*
* BrainBrowser: Web-based Neurological Visualization Tools
* (https://brainbrowser.cbrain.mcgill.ca)
*
* Copyright (C) 2011
* The Royal Institution for the Advancement of Learning
* McGill University
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as
* published by the Free Software Foundation, either version 3 of the
* License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
* BrainBrowser v1.5.3
*
* Author: Tarek Sherif  <tsherif@gmail.com> (http://tareksherif.ca/)
* Author: Nicolas Kassis
*/
!function(){"use strict";var a=window.BrainBrowser=window.BrainBrowser||{};a.createColorMap=function(a){function b(a,b,d,e){var f,g,h,i=document.createElement("canvas"),j=new Array(256);for($(i).attr("width",256),$(i).attr("height",d),f=0;256>f;f++)e?j[255-f]=f:j[f]=f;for(a=c.mapColors(j,{scale255:!0}),h=i.getContext("2d"),g=0;256>g;g++)h.fillStyle="rgb("+Math.floor(a[4*g])+", "+Math.floor(a[4*g+1])+", "+Math.floor(a[4*g+2])+")",h.fillRect(g,0,1,b);return i}var c={createCanvas:function(a){var d;return a||(a=c.colors),d=b(a,20,20,!1)},createCanvasWithScale:function(a,d,e){var f,g,h=c.colors;return f=b(h,20,40,e),g=f.getContext("2d"),g.fillStyle="#FFA000",g.fillRect(.5,20,1,10),g.fillText(a.toPrecision(3),.5,40),g.fillRect(f.width/4,20,1,10),g.fillText(((a+d)/4).toPrecision(3),f.width/4,40),g.fillRect(f.width/2,20,1,10),g.fillText(((a+d)/2).toPrecision(3),f.width/2,40),g.fillRect(3*(f.width/4),20,1,10),g.fillText((3*((a+d)/4)).toPrecision(3),3*(f.width/4),40),g.fillRect(f.width-.5,20,1,10),g.fillText(d.toPrecision(3),f.width-20,40),f},mapColors:function(a,b){b=b||{};var d,e,f,g,h=void 0===b.min?0:b.min,i=void 0===b.max?255:b.max,j=void 0===b.scale255?!1:b.scale255,k=void 0===b.brightness?0:b.brightness,l=void 0===b.contrast?1:b.contrast,m=void 0===b.alpha?1:b.alpha,n=b.destination||[],o=c.colors,p=o.length,q=i-h,r=(q+q/p)/p,s=j?255:1,t=[];for(m*=s,d=0,e=a.length;e>d;d++)g=a[d],f=h>=g?0:a[d]>i?p-1:Math.floor((g-h)/r),t=o[f]||[0,0,0],n[4*d+0]=s*(t[0]*l+k),n[4*d+1]=s*(t[1]*l+k),n[4*d+2]=s*(t[2]*l+k),n[4*d+3]=m;return n}};return function(){if(a){a=a.replace(/^\s+/,"").replace(/\s+$/,"");var b,d,e,f,g,h=a.split(/\n/),i=[];for(b=0,e=h.length;e>b;b++)if(g=h[b].replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/).slice(0,4),f=g.length,!(3>f)){for(d=0;f>d;d++)g[d]=parseFloat(g[d]);4>f&&g.push(1),i.push(g)}c.colors=i}}(),c}}(),function(){"use strict";var a=window.BrainBrowser=window.BrainBrowser||{},b="1.5.3";a.version=b.indexOf("BRAINBROWSER_VERSION")>0?"D.E.V":b,a.utils={canvasEnabled:function(){return!!document.createElement("canvas")},webglEnabled:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}},webWorkersEnabled:function(){return!!window.Worker},webGLErrorMessage:function(){var a,b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';return b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>",b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.',a=document.createElement("div"),a.id="webgl-error",a.innerHTML=b,a},isFunction:function(a){return a instanceof Function||"function"==typeof a},isNumeric:function(a){return!isNaN(parseFloat(a))},eventModel:function(a){var b=[];a.addEventListener=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},a.triggerEvent=function(c){var d=Array.prototype.slice.call(arguments,1);b[c]&&b[c].forEach(function(b){setTimeout(function(){b.apply(a,d)},0)})}},min:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&Array.isArray(a[0])?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]<d&&(d=a[b]);return d},max:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&Array.isArray(a[0])?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]>d&&(d=a[b]);return d},getOffset:function(a){for(var b=0,c=0;a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft,a=a.offsetParent;return{top:b,left:c}},checkConfig:function(b){if(!a.config)return!1;b=b||"";var c,d,e,f=a.config,g=b.split(".");for(d=0,e=g.length;e>d;d++){if(c=g[d],!f[c])return!1;f=f[c]}return!0},drawDot:function(a,b,c,d){var e=new THREE.SphereGeometry(2),f=new THREE.MeshBasicMaterial({color:16711680}),g=new THREE.Mesh(e,f);g.position.set(b,c,d),a.add(g)}},window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||function(a){window.clearTimeout(a)}}(),function(){"use strict";function a(){var a={deindex:"deindex.worker.js"},d=b.config.surface_viewer;b.utils.checkConfig("surface_viewer.model_types")&&Object.keys(d.model_types).forEach(function(b){a[b+"_model"]=d.model_types[b].worker}),b.utils.checkConfig("surface_viewer.intensity_data_types")&&Object.keys(d.intensity_data_types).forEach(function(b){a[b+"_intensity"]=d.intensity_data_types[b].worker}),Object.keys(a).forEach(function(b){var e=d.worker_dir+"/"+a[b];if(window.URL&&window.URL.createObjectURL){var f,g,h=new XMLHttpRequest;h.open("GET",e),h.onreadystatechange=function(){4===h.readyState&&(f=h.status,f>=200&&300>f||304===f?(g=new Blob([h.response],{type:"application/javascript"}),c.worker_urls[b]=window.URL.createObjectURL(g)):c.worker_urls[b]=e)},h.send()}else c.worker_urls[b]=e})}var b=window.BrainBrowser=window.BrainBrowser||{},c=b.SurfaceViewer={start:function(d,e){if(console.log("BrainBrowser Surface Viewer v"+b.version),!b.utils.webWorkersEnabled())return void alert("Can't find web workers. Exiting.");if(!b.utils.webglEnabled())return void alert("Can't get WebGL context. Exiting.");var f={},g={view_window:document.getElementById(d),model:null,getAttribute:function(a){return f[a]},setAttribute:function(a,b){f[a]=b}};b.utils.eventModel(g),Object.keys(c.modules).forEach(function(a){c.modules[a](g)}),b.utils.checkConfig("surface_viewer.worker_dir")&&a(),e(g)}};c.modules={},c.worker_urls={}}(),BrainBrowser.SurfaceViewer.parseIntensityData=function(a,b,c){"use strict";function d(){var b=new Worker(BrainBrowser.SurfaceViewer.worker_urls[e]);b.addEventListener("message",function(a){var d,e=a.data;for(d in e)e.hasOwnProperty(d)&&(f[d]=e[d]);c&&c(f),b.terminate()}),b.postMessage({cmd:"parse",data:a})}var e=b+"_intensity";if(!BrainBrowser.utils.checkConfig("surface_viewer.worker_dir"))throw new Error("error in SurfaceViewer configuration.\nBrainBrowser.config.surface_viewer.worker_dir not defined.");if(!BrainBrowser.SurfaceViewer.worker_urls[e])throw new Error("error in SurfaceViewer configuration.\nIntensity data worker URL for "+b+" not defined.");var f={};f.createColorArray=function(a,b,c,d,e,g,h,i){c=c.colors;var j,k,l,m,n=f.values,o=[],p=c.length,q=b-a,r=(q+q/p)/p;for(j=0,k=n.length;k>j;j++)m=n[j],l=a>=m?a>m&&!e?-1:0:m>b?e?p-1:-1:Math.floor((m-a)/r),d&&-1!==l?o.push.apply(o,c[p-1-l]):-1===l?4===g.length?o.push.apply(o,g):o.push(g[4*j],g[4*j+1],g[4*j+2],g[4*j+3]):o.push.apply(o,c[l]);i&&i(o)},a&&("string"==typeof a?d(a):a.values?(f.values=a.values.concat(),f.min=BrainBrowser.utils.min(f.values),f.max=BrainBrowser.utils.max(f.values)):(f.values=a,f.min=BrainBrowser.utils.min(a),f.max=BrainBrowser.utils.max(a)))},BrainBrowser.SurfaceViewer.modules.color=function(a){"use strict";function b(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(i=0,k=b.length;k>i;i++){for(d=b[i],l=d.getObjectByName("__wireframe__"),p=!!l,p&&(m=l.geometry.attributes.color.array),c=d.geometry,e=d.geometry.original_data.indices,f=c.attributes.color,g=f.array,h=0,j=e.length;j>h;h+=3)n=4*h,o=2*n,g[n]=a[4*e[h]],g[n+1]=a[4*e[h]+1],g[n+2]=a[4*e[h]+2],g[n+3]=1,g[n+4]=a[4*e[h+1]],g[n+5]=a[4*e[h+1]+1],g[n+6]=a[4*e[h+1]+2],g[n+7]=1,g[n+8]=a[4*e[h+2]],g[n+9]=a[4*e[h+2]+1],g[n+10]=a[4*e[h+2]+2],g[n+11]=1,p&&(m[o]=g[n],m[o+1]=g[n+1],m[o+2]=g[n+2],m[o+3]=g[n+3],m[o+4]=g[n+4],m[o+5]=g[n+5],m[o+6]=g[n+6],m[o+7]=g[n+7],m[o+8]=g[n+4],m[o+9]=g[n+5],m[o+10]=g[n+6],m[o+11]=g[n+7],m[o+12]=g[n+8],m[o+13]=g[n+9],m[o+14]=g[n+10],m[o+15]=g[n+11],m[o+16]=g[n+8],m[o+17]=g[n+9],m[o+18]=g[n+10],m[o+19]=g[n+11],m[o+20]=g[n],m[o+21]=g[n+1],m[o+22]=g[n+2],m[o+23]=g[n+3]);f.needsUpdate=!0,p&&(l.geometry.attributes.color.needsUpdate=!0)}}function c(a){var b,c,d,e,f,g,h=a[0];for(b=0,d=a[0].length/4;d>b;b++)for(c=1,e=a.length;e>c;c++)f=h[4*b+3],g=a[c][4*b+3],h[4*b]=h[4*b]*f+a[c][4*b]*g,h[4*b+1]=h[4*b+1]*f+a[c][4*b+1]*g,h[4*b+2]=h[4*b+2]*f+a[c][4*b+2]*g,h[4*b+3]=f+g;return h}function d(a,b){var d,e,f=b.length,g=new Array(f);for(d=0;f>d;d++)e=b[d],g[d]=a.mapColors(e.values,{min:e.range_min,max:e.range_max,alpha:e.alpha});return c(g)}var e=null;a.updateColors=function(c,f){function g(d){var e;e=c.apply_to_shape?[a.model.getObjectByName(c.apply_to_shape,!0)]:a.model.children,b(d,e),a.triggerEvent("updatecolors",c,j,k,n),i&&i()}f=f||{};var h=f.blend,i=f.complete,j=c.range_min,k=c.range_max,l=a.getAttribute("flip_colors"),m=a.getAttribute("clamp_colors"),n=a.color_map;clearTimeout(e),e=setTimeout(function(){h?g(d(n,c,0,1)):c.createColorArray(j,k,n,l,m,a.model_data.colors,a.model_data,g)},0)},a.setIntensityRange=function(b,c,d){d=d||{};var e=a.model_data.intensity_data;e.range_min=b,e.range_max=c,a.updateColors(e,{complete:d.complete}),a.triggerEvent("rangechange",e)},a.blend=function(b){var c,d=a.blendData,e=d.length;for(d[0].alpha=b,d[1].alpha=1-b,c=2;e>c;c++)d[c].alpha=0;a.updateColors(d,{blend:!0})}},BrainBrowser.SurfaceViewer.modules.loading=function(a){"use strict";function b(b,c,d){c=c||{};var e,f=c.before,g=new XMLHttpRequest,i=b.split("/"),j=i[i.length-1];f&&(f(),delete c.before),g.open("GET",b),g.onreadystatechange=function(){if(4===g.readyState){if(e=g.status,!(e>=200&&300>e||304===e)){var f="error loading URL: "+b+"\nHTTP Response: "+g.status+"\nHTTP Status: "+g.statusText+"\nResponse was: \n"+g.response;throw a.triggerEvent("error",f),new Error(f)}h(c)||d(g.response,j,c)}},g.send()}function c(a,b,c){var d=a.files;if(0!==d.length){b=b||{};var e=b.before,f=new FileReader,g=a.value.split("\\"),h=g[g.length-1];f.file=d[0],e&&(e(),delete b.before),f.onloadend=function(a){c(a.target.result,h,b)},f.readAsText(d[0])}}function d(a,b,c){c=c||{};var d=c.format||"mniobj",e=c.parse||{};i(a,d,e,function(a){h(c)||j(a,b,c)})}function e(b,c,d){d=d||{};var e=d.name||c,f=d.format||"mniobj",g=a.model_data,h=d.blend_index||0,i=1-h,j={};a.getAttribute("fix_color_range")&&g.intensity_data&&(j={min:g.intensity_data.range_min,max:g.intensity_data.range_max}),a.blendData=a.blendData||[],n.parseIntensityData(b,f,function(b){var c,f;a.getAttribute("fix_color_range")&&void 0!==j.min&&void 0!==j.max?(c=j.min,f=j.max):(c=void 0===d.min?b.min:d.min,f=void 0===d.max?b.max:d.max),b.filename=e,b.apply_to_shape=d.shape,b.applied=!1,g.intensity_data=b,a.blendData[h]=b,b.range_min=c,b.range_max=f,a.blendData[i]&&a.blendData[i].applied?(a.blendData[i].range_min=BrainBrowser.utils.min(a.blendData[i].values),a.blendData[i].range_max=BrainBrowser.utils.max(a.blendData[i].values),a.blend(.5),a.triggerEvent("loadintensitydata",a.blendData),a.triggerEvent("blendcolormaps",b.range_min,b.range_max,b)):(a.triggerEvent("loadintensitydata",b),a.updateColors(b,{complete:d.complete})),b.applied=!0})}function f(b){var c=a.model_data;a.color_map=BrainBrowser.createColorMap(b),a.triggerEvent("loadcolormap",a.color_map),c&&c.intensity_data&&a.updateColors(c.intensity_data)}function g(a,b){var c,d,e;c=new XMLHttpRequest,a.match(/.*.mnc/)?c.open("POST","/minc/volume_object_evaluate",!1):c.open("POST","/nii/volume_object_evaluate",!1),d=new FormData(document.getElementById("datafile-form")),c.send(d),e=c.response,b(e)}function h(a){a=a||{};var b=a.cancel||{};BrainBrowser.utils.isFunction(b)&&(b={test:b});var c=b.test,d=b.cleanup,e=!1;return c&&c()&&(e=!0,d&&d()),e}function i(b,c,d,e){var f,g=c+"_model";if(!BrainBrowser.utils.checkConfig("surface_viewer.worker_dir"))throw new Error("error in SurfaceViewer configuration.\nBrainBrowser.config.surface_viewer.worker_dir not defined.");if(!n.worker_urls[g])throw f="error in SurfaceViewer configuration.\nModel worker URL for "+c+" not defined.",a.triggerEvent("error",f),new Error(f);var h,i=new Worker(n.worker_urls[g]);i.addEventListener("message",function(b){var g=b.data;if(g.error)throw f="error parsing model.\n"+g.error_message+"\nFile type: "+c+"\nOptions: "+JSON.stringify(d),a.triggerEvent("error",f),new Error(f);e&&(h=new Worker(n.worker_urls.deindex),h.addEventListener("message",function(a){e(a.data)}),h.postMessage(g)),i.terminate()}),i.postMessage({data:b,options:d})}function j(b,c,d){d=d||{};var e=d.render_depth,f=d.complete;k(b,c,e),a.triggerEvent("displaymodel",a.model),f&&f()}function k(b,c,d){var e,f,g,h,i=a.model,j=b.shapes,k="line"===b.type;if(a.model_data=b,j){for(g=0,h=j.length;h>g;g++)f=b.shapes[g],e=l(f,k),e.name=f.name||c,e.geometry.original_data={vertices:b.vertices,indices:f.indices,normals:b.normals,colors:b.colors},d&&(e.renderDepth=d),i.add(e);b.split&&(i.children[0].name="left",i.children[0].model_num=0,i.children[1].name="right",i.children[1].model_num=1)}}function l(a,b){var c,d,e=a.unindexed,f=a.wireframe,g=a.centroid,h=e.position,i=e.normal||[],j=e.color||[],k=new THREE.BufferGeometry;return k.dynamic=!0,k.attributes.position={itemSize:3,array:new Float32Array(h),numItems:h.length},i.length>0?k.attributes.normal={itemSize:3,array:new Float32Array(i)}:k.computeVertexNormals(),j.length>0&&(k.attributes.color={itemSize:4,array:new Float32Array(j)}),b?(c=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),d=new THREE.Line(k,c,THREE.LinePieces)):(c=new THREE.MeshPhongMaterial({color:16777215,ambient:16777215,specular:1052688,shininess:150,vertexColors:THREE.VertexColors}),d=new THREE.Mesh(k,c),d.add(m(d,f))),d.centroid=g,d.position.set(g.x,g.y,g.z),d}function m(a,b){var c,d,e=new THREE.BufferGeometry;return e.attributes.position={itemSize:3,array:b.position,numItems:b.position.length},e.attributes.color={itemSize:4,array:b.color},e.attributes.color.needsUpdate=!0,c=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),d=new THREE.Line(e,c,THREE.LinePieces),d.name="__wireframe__",d.visible=!1,a.wireframe_active=!1,d}var n=BrainBrowser.SurfaceViewer;a.loadModelFromURL=function(a,c){b(a,c,d)},a.loadModelFromFile=function(a,b){c(a,b,d)},a.loadIntensityDataFromURL=function(a,c){b(a,c,e)},a.loadIntensityDataFromFile=function(a,b){var d=a.files[0].name;d.match(/.*.mnc|.*.nii/)?g(d,e):c(a,b,e)},a.loadColorMapFromURL=function(a,c){b(a,c,f)},a.loadColorMapFromFile=function(a,b){c(a,b,f)}},BrainBrowser.SurfaceViewer.modules.rendering=function(a){"use strict";function b(e){var h,j,k=a.model;window.requestAnimationFrame(b),d=c||e,c=e,h=c-d,j=15e-5*h,a.autorotate.x&&(k.rotation.x+=j),a.autorotate.y&&(k.rotation.y+=j),a.autorotate.z&&(k.rotation.z+=j),i.render(f,g)}var c,d,e=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}),f=new THREE.Scene,g=new THREE.PerspectiveCamera(30,a.view_window.offsetWidth/a.view_window.offsetHeight,1,1e4),h=new THREE.PointLight(16777215),i=e,j={},k=e.domElement;a.model=new THREE.Object3D,f.add(a.model),a.render=function(){var c=a.view_window;e.setClearColor(0),e.setSize(c.offsetWidth,c.offsetHeight),c.appendChild(e.domElement),g.position.z=500,h.position.set(0,0,500),f.add(h),a.autorotate={},window.onresize=function(){i.setSize(c.offsetWidth,c.offsetHeight),g.aspect=c.offsetWidth/c.offsetHeight,g.updateProjectionMatrix()},window.onresize(),b()},a.getVertexInfo=function(b){var c=a.model_data.vertices,d=3*b;return{index:b,point:new THREE.Vector3(c[d],c[d+1],c[d+2])}},a.canvasDataURL=function(){return e.domElement.toDataURL()},a.addEffect=function(b){var c;THREE[b]&&(c=new THREE[b](e),c.setSize(a.view_window.offsetWidth,a.view_window.offsetHeight),j[b]=c)},a.setEffect=function(a){i=j[a]?j[a]:e},a.setCamera=function(a,b,c){g.position.set(a,b,c),h.position.set(a,b,c)},a.resetView=function(){var b,c,d,e,f=a.model,i=new THREE.Matrix4;for(i.getInverse(f.matrix),f.applyMatrix(i),g.position.set(0,0,500),h.position.set(0,0,500),d=0,e=a.model.children.length;e>d;d++)b=f.children[d],b.centroid?b.position.set(b.centroid.x,b.centroid.y,b.centroid.z):b.position.set(0,0,0),b.rotation.set(0,0,0),c=b.getObjectByName("__wireframe__")},a.zoom=function(a){var b=g.position,c=b.z/a;c>g.near&&c<.9*g.far&&(b.z=c,h.position.z=c)},a.setClearColor=function(a){e.setClearColor(a,1)},a.pick=function(b,c){b=b/a.view_window.offsetWidth*2-1,c=-c/a.view_window.offsetHeight*2+1;var d,e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=a.model,x=new THREE.Projector,y=new THREE.Raycaster,z=new THREE.Vector3(b,c,g.near),A=new THREE.Matrix4;if(x.unprojectVector(z,g),y.set(g.position,z.sub(g.position).normalize()),d=y.intersectObject(w,!0),d.length>0){for(e=d[0],h=e.object,j=e.indices,s=h.centroid,t=s.x,u=s.y,v=s.z,A.getInverse(h.matrixWorld),i=e.point.applyMatrix4(A),m=h.geometry.original_data.vertices,n=h.geometry.original_data.indices,k=o=n[j[0]],l=i.distanceTo(new THREE.Vector3(m[3*o]-t,m[3*o+1]-u,m[3*o+2]-v)),q=1,r=j.length;r>q;q++)o=n[j[q]],p=i.distanceTo(new THREE.Vector3(m[3*o]-t,m[3*o+1]-u,m[3*o+2]-v)),l>p&&(k=o,l=p);f={index:k,point:new THREE.Vector3(e.point.x,e.point.y,e.point.z),object:e.object}}else f=null;return f},function(){function b(a){var b,c,d=BrainBrowser.utils.getOffset(k);return void 0!==a.pageX?(b=a.pageX,c=a.pageY):(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),b-=d.left,c-=d.top,{x:b,y:c}}function c(a,c){c=c||1;var d,e,f=new THREE.Matrix4,i=b(a),j=i.x,k=i.y;if(null!==o)if(d=j-o,e=k-p,"rotate"===n){f.getInverse(m.matrix);var l=new THREE.Vector3(1,0,0).applyMatrix4(f).normalize();m.rotateOnAxis(l,e/150),f.getInverse(m.matrix),l=new THREE.Vector3(0,1,0).applyMatrix4(f).normalize(),m.rotateOnAxis(l,d/150)}else g.position.x-=d*c,h.position.x-=d*c,g.position.y+=e*c,h.position.y+=e*c;o=j,p=k}function d(c){var d,e=b(c.touches[0]),f=b(c.touches[1]),g=e.x-f.x,h=e.y-f.y,i=Math.sqrt(g*g+h*h);null!==q&&(d=i-q,a.zoom(1+.01*d)),q=i}function e(a){a.preventDefault(),a.stopPropagation(),c(a,.25)}function f(a){a.preventDefault(),a.stopPropagation(),"zoom"===n?d(a):c(a.touches[0],1)}function i(){document.removeEventListener("mousemove",e,!1),document.removeEventListener("mouseup",i,!1),o=null,p=null}function j(){document.removeEventListener("touchmove",f,!1),document.removeEventListener("touchend",j,!1),o=null,p=null,q=null}function l(b){var c=Math.max(-1,Math.min(1,b.wheelDelta||-b.detail));b.preventDefault(),b.stopPropagation(),a.zoom(1+.05*c)}var m=a.model,n="rotate",o=null,p=null,q=null;k.addEventListener("mousedown",function(a){document.addEventListener("mousemove",e,!1),document.addEventListener("mouseup",i,!1),n=1===a.which?"rotate":"translate"},!1),k.addEventListener("touchstart",function(a){document.addEventListener("touchmove",f,!1),document.addEventListener("touchend",j,!1),n=1===a.touches.length?"rotate":2===a.touches.length?"zoom":"translate"},!1),k.addEventListener("mousewheel",l,!1),k.addEventListener("DOMMouseScroll",l,!1),k.addEventListener("contextmenu",function(a){a.preventDefault(),a.stopPropagation()},!1)}()},BrainBrowser.SurfaceViewer.modules.views=function(a){"use strict";function b(a){return a*Math.PI/180}var c={medialView:function(){var c=a.model;a.model_data.split&&(c.getObjectByName("left").position.x-=100,c.getObjectByName("left").rotation.z-=b(90),c.getObjectByName("right").position.x+=100,c.getObjectByName("right").rotation.z+=b(90),c.rotation.x+=b(-90))},lateralView:function(){var c,d,e=a.model;a.model_data.split&&(c=e.getObjectByName("left"),d=e.getObjectByName("right"),c.position.x-=100,c.rotation.z+=b(-90),d.position.x+=100,d.rotation.z+=b(90),e.rotation.x+=b(90),e.rotation.y+=b(180))},inferiorView:function(){a.model.rotation.y+=b(180)},anteriorView:function(){a.resetView(),a.model.rotation.x+=b(-90),a.model.rotation.z+=b(180)},posteriorView:function(){a.resetView(),a.model.rotation.x+=b(-90)}};a.setTransparency=function(b,c){var d,e,f=a.model.getObjectByName(b);f&&(d=f.material,d.opacity=c,d.transparent=1===c?!1:!0,e=f.getObjectByName("__wireframe__"),e&&(e.material.opacity=d.opacity,e.material.transparent=d.transparent))},a.setWireframe=function(b){for(var c,d,e=a.model.children,f=0;f<e.length;f++)c=e[f],d=c.getObjectByName("__wireframe__"),d&&(c.visible=!b,d.visible=b,c.wireframe_active=b)},a.setView=function(b){var d=b+"View";a.resetView(),a.model_data&&a.model_data.split&&"function"==typeof c[d]&&c[d]()},a.clearScreen=function(){for(var b=a.model.children;b.length>0;)a.model.remove(b[0]);a.resetView(),a.triggerEvent("clearscreen")},a.separateHalves=function(b){b=b||1,a.model_data.split&&(a.model.children[0].position.x-=b,a.model.children[1].position.x+=b)}};