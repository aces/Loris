version: '3.8'

services:
  db:
    build:
      context: .
      dockerfile: Dockerfile.test.db
      args:
        BASE_DIR: /app/
    volumes:
      - ./test/mysql-config:/etc/mysql/conf.d
    environment:
      - MYSQL_DATABASE=LorisTest
      - MYSQL_ROOT_PASSWORD=rootpw   # fixed so healthcheck can log in
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-prootpw"]
      interval: 5s        # check every 5 seconds
      retries: 30         # allow 30 failed attempts
      start_period: 60s   # give MariaDB 60s before counting failures

  selenium:
    image: selenium/standalone-firefox:4.25
    ports:
      - "5900:5900"

  web:
    build:
      context: .
      dockerfile: Dockerfile.test.php8
    volumes:
      - ./:/app
      - ./test/test_instrument/NDB_BVL_Instrument_testtest.class.inc:/app/project/instruments/NDB_BVL_Instrument_testtest.class.inc
      - ./raisinbread/instruments:/app/project/instruments
      - ./logs:/app/logs  # Mount logs to the host machine
    environment:
      - LORIS_DB_CONFIG=/app/test/config.xml
    depends_on:
      db:
        condition: service_healthy
    command: php -S 0.0.0.0:8000 -t /app/htdocs /app/htdocs/router.php

  unit-tests:
    build:
      context: .
      dockerfile: Dockerfile.test.php8
    volumes:
      - ./:/app
      - ./logs:/app/logs
    working_dir: /app
    environment:
      - LORIS_DB_CONFIG=test/config.xml
    depends_on:
      db:
        condition: service_healthy
    entrypoint: /app/test/wait-for-services.sh

  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile.test.php8
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      - LORIS_DB_CONFIG=test/config.xml
      - SELENIUM_REQUIRED=true
      - DOCKER_WEB_SERVER=http://web:8000
    depends_on:
      db:
        condition: service_healthy
      selenium:
        condition: service_started
      web:
        condition: service_started
    entrypoint: /app/test/wait-for-services.sh

