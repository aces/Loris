!function(e){function t(s){if(a[s])return a[s].exports;var i=a[s]={exports:{},id:s,loaded:!1};return e[s].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});/**
	 *  The following file contains the base component for the data query react app.
	 *  It also contains the component for the saved queries dropdown.
	 *
	 *  @author   Jordan Stirling <jstirling91@gmail.com>
	 *  @author   Dave MacFarlane <david.macfarlane2@mcgill.ca>
	 *  @license  http://www.gnu.org/licenses/gpl-3.0.txt GPLv3
	 *  @link     https://github.com/mohadesz/Loris-Trunk
	 */
var a=React.createClass({displayName:"SavedQueriesList",getDefaultProps:function(){},componentDidMount:function(){},loadQuery:function(e){this.props.onSelectQuery(this.props.queryDetails[e].Fields,this.props.queryDetails[e].Conditions)},render:function(){var e,t,a=[],s=[];if(this.props.queriesLoaded===!1)return React.createElement("div",null);for(var i=0;i<this.props.userQueries.length;i+=1)t=this.props.queryDetails[this.props.userQueries[i]],console.log(t.Meta),e=t.Meta&&t.Meta.name?t.Meta.name:this.props.userQueries[i],a.push(React.createElement("li",{key:this.props.userQueries[i]},React.createElement("a",{href:"#",onClick:this.loadQuery.bind(this,this.props.userQueries[i])},e)));for(var i=0;i<this.props.globalQueries.length;i+=1)t=this.props.queryDetails[this.props.globalQueries[i]],console.log(t.Meta),e=t.Meta&&t.Meta.name?t.Meta.name:this.props.globalQueries[i],s.push(React.createElement("li",{key:this.props.globalQueries[i]},React.createElement("a",{href:"#",onClick:this.loadQuery.bind(this,this.props.globalQueries[i])},e)));return React.createElement("ul",{className:"nav nav-tabs navbar-right"},React.createElement("li",{className:"dropdown"},React.createElement("a",{href:"#",className:"dropdown-toggle","data-toggle":"dropdown",role:"button","aria-expanded":"false"},"Load Saved Query ",React.createElement("span",{className:"caret"})),React.createElement("ul",{className:"dropdown-menu",role:"menu"},React.createElement("li",{role:"presentation",className:"dropdown-header"},"User Saved Queries"),a,React.createElement("li",{role:"presentation",className:"dropdown-header"},"Shared Saved Queries"),s)),React.createElement("li",{role:"presentation"},React.createElement("a",{href:"#SavedQueriesTab","data-toggle":"tab"},"Manage Saved Queries")))}}),s=React.createClass({displayName:"DataQueryApp",componentDidMount:function(){var e=this;$(e).find('a[data-toggle="tab"]').on("shown.bs.tab",function(t){$(e).find("li").removeClass("active"),t.target&&(t.target.classList.add("active"),t.target.parentNode&&t.target.parentNode.classList.add("active"))});var t=[],a=this;for(var s in this.state.queryIDs){console.log(this.state.queryIDs[s][0]);for(var i=0;i<this.state.queryIDs[s].length;i+=1){var r;r=Promise.resolve($.ajax(loris.BaseURL+"/AjaxHelper.php?Module=dataquery&script=GetDoc.php&DocID="+a.state.queryIDs[s][i]),{data:{DocID:a.state.queryIDs[s][i]},dataType:"json"}).then(function(e){var t=a.state.savedQueries;t[e._id]=e,a.setState({savedQueries:t})}),t.push(r)}}var l=(Promise.all(t).then(function(e){a.setState({queriesLoaded:!0})}),this);$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){l.setState({ActiveTab:e.target.getAttribute("href").substr(1)})})},saveFilterRule:function(e){var t={field:e.field,operator:e.operator,value:e.value,instrument:e.instrument,visit:e.visit};return t},saveFilterGroup:function(e){for(var t={activeOperator:e.activeOperator,children:[]},a=0;a<e.children.length;a++)"rule"===e.children[a].type?t.children.push(this.saveFilterRule(e.children[a])):"group"===e.children[a].type&&t.children.push(this.saveFilterGroup(e.children[a]));return t},saveCurrentQuery:function(e,t){var a=this,s=this.saveFilterGroup(this.state.filter);$.post(loris.BaseURL+"/AjaxHelper.php?Module=dataquery&script=saveQuery.php",{Fields:this.state.selectedFields,Filters:s,QueryName:e,SharedQuery:t},function(e){var s=JSON.parse(e).id,i=a.state.queryIDs;t===!0?i.Shared.push(s):i.User.push(s),$.get(loris.BaseURL+"/AjaxHelper.php?Module=dataquery&script=GetDoc.php&DocID="+s,function(e){var t=a.state.savedQueries;t[e._id]=e,a.setState({savedQueries:t,queryIDs:i,alertLoaded:!1,alertSaved:!0})})})},getInitialState:function(){return{displayType:"Cross-sectional",fields:[],criteria:{},sessiondata:{},grouplevel:0,queryIDs:this.props.SavedQueries,savedQueries:{},queriesLoaded:!1,alertLoaded:!1,alertSaved:!1,ActiveTab:"Info",rowData:{},filter:{type:"group",activeOperator:0,children:[{type:"rule"}],session:this.props.AllSessions},selectedFields:{},downloadableFields:{},loading:!1}},loadFilterRule:function(e){var t;e.type||(e.type="rule"),$.ajax({url:loris.BaseURL+"/AjaxHelper.php?Module=dataquery&script=datadictionary.php",success:function(t){e.fields=t},async:!1,data:{category:e.instrument},dataType:"json"});for(var a=0;a<e.fields.length;a++)if(e.fields[a].key[1]===e.field){e.fieldType=e.fields[a].value.Type;break}switch(e.operator){case"equal":t="queryEqual.php";break;case"notEqual":t="queryNotEqual.php";break;case"lessThanEqual":t="queryLessThanEqual.php";break;case"greaterThanEqual":t="queryGreaterThanEqual.php";break;case"startsWith":t="queryStartsWith.php";break;case"contains":t="queryContains.php"}return $.ajax({url:loris.BaseURL+"/AjaxHelper.php?Module=dataquery&script="+t,success:function(t){var a,s={},i={};for(a=0;a<t.length;a++)s[t[a][1]]||(s[t[a][1]]=[]),s[t[a][1]].push(t[a][0]),i[t[a][0]]||(i[t[a][0]]=[]),i[t[a][0]].push(t[a][1]);e.candidates={allCandiates:i,allSessions:s},"All"==e.visit?e.session=Object.keys(i):s[e.visit]?e.session=s[e.visit]:e.session=[]},async:!1,data:{category:e.instrument,field:e.field,value:e.value},dataType:"json"}),e},loadFilterGroup:function(e){for(var t=0;t<e.children.length;t++)e.children[t].activeOperator?(e.children[t].type||(e.children[t].type="group"),e.children[t]=this.loadFilterGroup(e.children[t])):e.children[t]=this.loadFilterRule(e.children[t]);return e.session=getSessions(e),e},loadSavedQuery:function(e,t){var a={},s={},i=[];if(this.setState({loading:!0}),Array.isArray(t)){a={type:"group",activeOperator:0,children:[]},a.children=t.map(function(e){var t=e.Field.split(",");switch(rule={instrument:t[0],field:t[1],value:e.Value,type:"rule",visit:"All"},e.Operator){case"=":rule.operator="equal";break;case"!=":rule.operator="notEqual";break;case"<=":rule.operator="lessThanEqual";break;case">=":rule.operator="greaterThanEqual";break;default:rule.operator=e.Operator}return rule});var r;i=e;for(var l=0;l<e.length;l++)if(r=e[l].split(","),s[r[0]]){s[r[0]][r[1]]={};for(var n in this.props.Visits)s[r[0]].allVisits[n]++,s[r[0]][r[1]][n]=[n]}else{s[r[0]]={},s[r[0]][r[1]]={},s[r[0]].allVisits={};for(var n in this.props.Visits)s[r[0]].allVisits[n]=1,s[r[0]][r[1]][n]=[n]}}else{a=t,s=e;for(var o in e)for(var d in e[o])"allVisits"!==d&&i.push(o+","+d)}a.children&&a.children.length>0?a=this.loadFilterGroup(a):(a.children=[{type:"rule"}],a.session=this.props.AllSessions),this.setState(function(e){return{fields:i,selectedFields:s,filter:a,alertLoaded:!0,alertSaved:!1,loading:!1}})},fieldVisitSelect:function(e,t,a){this.setState(function(s){var i=s.selectedFields[a.instrument];return"check"===e?(i[a.field][t]=t,i.allVisits[t]?i.allVisits[t]++:i.allVisits[t]=1):(delete i[a.field][t],1===i.allVisits[t]?delete i.allVisits[t]:i.allVisits[t]--),i})},fieldChange:function(e,t,a){var s=this;this.setState(function(i){var r=i.selectedFields,l=i.fields.slice(0);if(r[t])if(r[t][e]){for(var n in r[t][e])1===r[t].allVisits[n]?delete r[t].allVisits[n]:r[t].allVisits[n]--;delete r[t][e];var o=l.indexOf(t+","+e);l.splice(o,1),1===Object.keys(r[t]).length&&delete r[t],a&&delete i.downloadableFields[t+","+e]}else{r[t][e]||(r[t][e]={});for(var n in r[t].allVisits)"allVisits"!=n&&(r[t].allVisits[n]++,r[t][e][n]=n);l.push(t+","+e),a&&(i.downloadableFields[t+","+e]=!0)}else{r[t]={},r[t][e]=JSON.parse(JSON.stringify(s.props.Visits)),r[t].allVisits={};for(var n in s.props.Visits)r[t].allVisits[n]=1;l.push(t+","+e),a&&(i.downloadableFields[t+","+e]=!0)}return{selectedFields:r,fields:l}})},getSessions:function(){return this.state.filter.children.length>0?this.state.filter.session:this.props.AllSessions},runQuery:function(e,t){var a,s=[],i=this,r=0,l=function(){if(0==r){var e=i.getRowData(i.state.grouplevel);i.setState({rowData:e,loading:!1})}};this.setState({rowData:{},sessiondata:{},loading:!0});for(var n=0;n<e.length;n+=1){var o=e[n].split(","),d=o[0];if(s.indexOf(d)===-1){for(var c=[],u=0;u<this.state.filter.session.length;u++)if(Array.isArray(this.state.filter.session[u]))this.state.selectedFields[d].allVisits[this.state.filter.session[u][1]]&&c.push(this.state.filter.session[u]);else for(var p in this.state.selectedFields[d].allVisits){var h=[];h.push(this.state.filter.session[u]),h.push(p),c.push(h)}s.push(d),r++,a=JSON.stringify(c),$.ajax({type:"POST",url:loris.BaseURL+"/AjaxHelper.php?Module=dataquery&script=retrieveCategoryDocs.php",data:{DocType:d,Sessions:a},dataType:"text",success:function(e){if(e){var t,a,s,n,o=i.state.sessiondata;for(e=JSON.parse(e),s=e.rows,t=0;t<s.length;t+=1)a=s[t],n=a.value,o.hasOwnProperty(n)||(o[n]={}),o[n][a.key[0]]=a.doc;i.setState({sessiondata:o})}console.log("Received data"),r--,l()}})}}},getRowData:function(e){var t,a,s=this.state.sessiondata,i=(this.getSessions(),this.state.fields.sort()),r=this.state.downloadableFields,l=[],n=[],o=[],d=[],c=[];if(0===e){for(t=0;i&&t<i.length;t+=1)d.push(i[t]);for(var u in s){for(n=[],t=0;i&&t<i.length;t+=1){var p=i[t].split(",");n[t]=".";var h=s[u];h[p[0]]&&h[p[0]].data[p[1]]&&r[i[t]]?(a=loris.BaseURL+"/mri/jiv/get_file.php?file="+h[p[0]].data[p[1]],n[t]=React.createElement("a",{href:a},h[p[0]].data[p[1]]),c.push("file/"+h[p[0]]._id+"/"+encodeURIComponent(h[p[0]].data[p[1]]))):h[p[0]]&&(n[t]=h[p[0]].data[p[1]])}l.push(n),o.push(u)}}else{var f,v,g,y,m,R,p,b={};for(var u in s)s[u.toUpperCase()]=s[u],delete u[u],g=u.split(","),f=g[1].toUpperCase(),b[f]||(b[f]=!0),v=g[0].toUpperCase(),o.indexOf(v)===-1&&o.push(v);for(t=0;i&&t<i.length;t+=1)for(f in b)g=i[t].split(","),R=this.state.selectedFields[g[0]],R&&R[g[1]]&&R[g[1]][f]&&d.push(f+" "+i[t]);for(v in o){n=[];for(y in d)g=o[v]+","+d[y].split(" ")[0],m=s[g],m?(g=m[d[y].split(",")[0].split(" ")[1]],p=d[y].split(" ")[1].split(","),g?g.data[d[y].split(",")[1]]&&r[p[0]+","+p[1]]?(a=loris.BaseURL+"/mri/jiv/get_file.php?file="+g.data[d[y].split(",")[1]],g=React.createElement("a",{href:a},g.data[d[y].split(",")[1]])):g=g.data[d[y].split(",")[1]]:g=".",n.push(g)):n.push(".");l.push(n)}}return{rowdata:l,Identifiers:o,RowHeaders:d,fileData:c}},dismissAlert:function(){this.setState({alertLoaded:!1,alertSaved:!1})},resetQuery:function(){this.setState({fields:[],criteria:{},selectedFields:{}})},changeDataDisplay:function(e){var t=this.getRowData(e);this.setState({grouplevel:e,rowData:t})},updateFilter:function(e){var t=this;this.setState(function(a){return 0===e.children.length&&(e.session=t.props.AllSessions),{filter:e}})},render:function(){var e=[],t=React.createElement("div",null);e.push(React.createElement(InfoTabPane,{TabId:"Info",UpdatedTime:this.props.UpdatedTime,Loading:this.state.loading})),e.push(React.createElement(FieldSelectTabPane,{TabId:"DefineFields",categories:this.props.categories,onFieldChange:this.fieldChange,selectedFields:this.state.selectedFields,Visits:this.props.Visits,fieldVisitSelect:this.fieldVisitSelect,Loading:this.state.loading})),e.push(React.createElement(FilterSelectTabPane,{TabId:"DefineFilters",categories:this.props.categories,filter:this.state.filter,updateFilter:this.updateFilter,Visits:this.props.Visits,Loading:this.state.loading}));var s=0===this.state.grouplevel?"Cross-sectional":"Longitudinal";e.push(React.createElement(ViewDataTabPane,{TabId:"ViewData",Fields:this.state.fields,Criteria:this.state.criteria,Sessions:this.getSessions(),Data:this.state.rowData.rowdata,RowInfo:this.state.rowData.Identifiers,RowHeaders:this.state.rowData.RowHeaders,FileData:this.state.rowData.fileData,onRunQueryClicked:this.runQuery,displayType:s,changeDataDisplay:this.changeDataDisplay,Loading:this.state.loading})),e.push(React.createElement(StatsVisualizationTabPane,{TabId:"Statistics",Fields:this.state.rowData.RowHeaders,Data:this.state.rowData.rowdata,Loading:this.state.loading})),e.push(React.createElement(ManageSavedQueriesTabPane,{TabId:"SavedQueriesTab",userQueries:this.state.queryIDs.User,globalQueries:this.state.queryIDs.Shared,onSaveQuery:this.saveCurrentQuery,queryDetails:this.state.savedQueries,queriesLoaded:this.state.queriesLoaded,Loading:this.state.loading})),this.state.alertLoaded&&(t=React.createElement("div",{className:"alert alert-success",role:"alert"},React.createElement("button",{type:"button",className:"close","aria-label":"Close",onClick:this.dismissAlert},React.createElement("span",{"aria-hidden":"true"},"×")),React.createElement("strong",null,"Success")," Query Loaded.")),this.state.alertSaved&&(t=React.createElement("div",{className:"alert alert-success",role:"alert"},React.createElement("button",{type:"button",className:"close","aria-label":"Close",onClick:this.dismissAlert},React.createElement("span",{"aria-hidden":"true"},"×")),React.createElement("strong",null,"Success")," Query Saved."));var i="col-md-12",r=React.createElement("div",null);return this.state.fields.length>0&&"ViewData"!==this.state.ActiveTab&&"Statistics"!==this.state.ActiveTab&&"Info"!==this.state.ActiveTab&&(i="col-md-10",r=React.createElement("div",{className:"col-md-2"},React.createElement(FieldsSidebar,{Fields:this.state.fields,Criteria:this.state.criteria,resetQuery:this.resetQuery}))),React.createElement("div",null,t,React.createElement("div",{className:i},React.createElement("nav",{className:"nav nav-tabs"},React.createElement("ul",{className:"nav nav-tabs navbar-left","data-tabs":"tabs"},React.createElement("li",{role:"presentation",className:"active"},React.createElement("a",{href:"#Info","data-toggle":"tab"},"Info")),React.createElement("li",{role:"presentation"},React.createElement("a",{href:"#DefineFields","data-toggle":"tab"},"Define Fields")),React.createElement("li",{role:"presentation"},React.createElement("a",{href:"#DefineFilters","data-toggle":"tab"},"Define Filters")),React.createElement("li",{role:"presentation"},React.createElement("a",{href:"#ViewData","data-toggle":"tab"},"View Data")),React.createElement("li",{role:"presentation"},React.createElement("a",{href:"#Statistics","data-toggle":"tab"},"Statistical Analysis"))),React.createElement(a,{userQueries:this.state.queryIDs.User,globalQueries:this.state.queryIDs.Shared,queryDetails:this.state.savedQueries,queriesLoaded:this.state.queriesLoaded,onSelectQuery:this.loadSavedQuery,loadedQuery:this.state.loadedQuery})),React.createElement("div",{className:"tab-content"},e)),r)}});window.SavedQueriesList=a,window.DataQueryApp=s,window.RDataQueryApp=React.createFactory(s),t.default=s}]);
//# sourceMappingURL=react.app.js.map