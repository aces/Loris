<?php

/**
 * Reads and ouputs the latest file generated by the MRI upload process.
 *
 * PHP version 5
 *
 * @category Script
 * @package  Main
 * @author   Olga Tsibulevskaya  <olgatsib@gmail.com>
 * @license  Loris License
 * @link     https://github.com/aces/Loris-Trunk
*/

if (!\User::singleton()->hasPermission('imaging_uploader')) {
    http_response_code(403);
    return;
}

header("Cache-Control: no-store, no-cache, must-revalidate");
require_once "../tools/generic_includes.php";


// Get the path to the file most recently modified by the MRI upload process.
$data_source_file = getLatestLogFile();

// Create a temp file to avoid truncating the original file.
$temp_data_source_file = $data_source_file . ".tmp";

// Create new temp file for reading if it doesn't exist.
if (file_exists($temp_data_source_file)) {
    if (!copy($data_source_file, $temp_data_source_file)) {
        throw new \LorisException(
            "Could not copy " .
            htmlspecialchars($data_source_file, ENT_QUOTES) .
            " to " .
            htmlspecialchars($temp_data_source_file, ENT_QUOTES)
        );
    }
}

clearstatcache();
$contents = file_get_contents($temp_data_source_file);
if (!$contents) {
    throw new \LorisException(
        "Could not read file contents from " .
        htmlspecialchars($temp_data_source_file, ENT_QUOTES)
    );
}
echo $contents;

/**
 * Get the last changed log file using in the
 * $paths['base'] . "/" . $paths['log'] . "/MRI_upload" directory

 * @return string The name of the last log file modified in the log directory.
 */
function getLatestLogFile(): string
{
    $paths = NDB_Config::singleton()->getSetting('paths');
    // Get the path from the config file.
    if (empty($paths)) {
        throw new ConfigurationException(
            "Paths could not be loaded from Config file!"
        );
    }

    // Get the directory name.
    $log_directory = $paths['base'] . "/" . $paths['log'] . "/MRI_upload";
    if (!file_exists($log_directory)) {
        throw new ConfigurationException(
            "Could not find a valid directory at " .
            htmlspecialchars($log_directory, ENT_QUOTES)
        );
    }

    // Get the last file modified.
    $files = glob($log_directory . "/*MRI_upload*");
    $files = array_combine($files, array_map("filemtime", $files));
    arsort($files);
    return key($files);
}
